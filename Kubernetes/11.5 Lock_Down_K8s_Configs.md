# 11.5 : Immutable ConfigMaps & Secrets â€“ Prevent Accidental Changes

https://drive.google.com/file/d/1MP2E90LLefF1GroC2xvCNZ_l_5NN0-Xc/view?usp=sharing

### ğŸ¯ What It Is

Starting in **Kubernetes 1.21+**, you can mark a **ConfigMap or Secret as `immutable`** â€” meaning it **cannot be updated or deleted** after creation (without full replacement).

> âœ… Why?
> 
> - Prevents accidental/malicious config changes
> - **Reduces load on kube-apiserver** (no watches for updates)
> - Improves **cluster performance** at scale

### ğŸ’¡ Real-World Analogy

> Like a sealed firmware chip in a device â€” once programmed, it canâ€™t be changed. To update, you replace the whole chip.
> 

---

### ğŸ§ª Example: Create an Immutable ConfigMap

**Step 1: Define an Immutable ConfigMap**

```yaml
# immutable-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-version
  namespace: prod
immutable: true  # â† This makes it immutable!

  VERSION: "2.1.0"
  BUILD_DATE: "2025-04-05"

```

Apply it:

```bash
kubectl apply -f immutable-config.yaml

```

**Step 2: Try to Edit It (It Fails!)**

```bash
kubectl edit cm app-version -n prod
# Make a change â†’ save

```

âŒ **Error**:

```
error: configmap "app-version" is immutable

```

âœ… **To update**: You must **delete and recreate** (or use a new name):

```bash
kubectl delete cm app-version -n prod
# Then apply a new version

```

**Step 3: Use in a Deployment (with rollout trigger)**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
      annotations:
        # Force rollout when config changes
        checksum/config: a1b2c3d4  # â† Update this hash manually
    spec:
      containers:
      - name: app
        image: nginx
        envFrom:
        - configMapRef:
            name: app-version

```

> ğŸ’¡ Tip: In CI/CD, auto-generate the hash:
> 
> 
> ```bash
> kubectl get cm app-version -o yaml | sha256sum
> 
> ```
> 

---

### âœ… Summary YAML

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-immutable-config
immutable: true  # â† Key line!

  KEY: "value"

```

> ğŸ” Same syntax works for Secrets:
> 
> 
> ```yaml
> apiVersion: v1
> kind: Secret
> metadata:
>   name: my-immutable-secret
> immutable: true
> stringData:
>   token: "secret123"
> 
> ```
> 

---

### â“ Common Questions

**Q: Can I make an existing ConfigMap immutable?**

âŒ **No!** Immutability must be set at **creation time**.

**Q: Does it improve security?**

â¡ï¸ Indirectly â€” prevents runtime tampering, but doesnâ€™t encrypt data.

**Q: What happens to Pods using an immutable ConfigMap?**

â¡ï¸ Same as regular ConfigMap:

> Env vars: âŒ No update (Pod must restart)Volume mounts: âœ… File updates still work (until you delete/recreate)
> 

**Q: Can I use `immutable: true` with Helm?**

âœ… Yes! But Helm **canâ€™t upgrade** it â€” youâ€™ll need a new name or manual delete.

---

### ğŸ› ï¸ Best Practices

1. âœ… Use for **stable, versioned config**:
    - App version, build info, feature flags that rarely change
2. âœ… **Combine with deployment annotations** to trigger rollouts:
    
    ```yaml
    annotations:
      checksum/config: <hash-of-configmap>
    
    ```
    
3. âœ… **Avoid for frequently changing config** (use regular ConfigMap + volume mount)
4. âœ… **Test in dev first** â€” immutable resources change your update workflow
5. âœ… Use in **production namespaces** to reduce API server load