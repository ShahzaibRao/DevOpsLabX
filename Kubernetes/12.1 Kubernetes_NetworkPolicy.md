# **12.1 : What Is a NetworkPolicy? (The Kubernetes Firewall)**

### ğŸ¯ What It Is

A **NetworkPolicy** is a Kubernetes resource that **controls traffic flow** between Pods â€” like a **firewall for your cluster**.

> âœ… By default, all Pods can talk to each other (open network).
> 
> 
> ğŸ”’ **NetworkPolicy adds restrictions** â€” â€œonly allow X to talk to Yâ€.
> 

### ğŸ’¡ Real-World Analogy

> Like a building security system:
> 
> - Without policy: Anyone can walk into any office
> - With policy: Only HR can enter payroll room; devs can only access dev servers

---

### ğŸ§ª Example: Isolate a â€œFrontendâ€ Pod

**Step 1: Deploy two apps (no policy yet)**

```yaml
# frontend.yaml
apiVersion: apps/v1
kind: Deployment
meta
  name: frontend
  labels:
    app: frontend
spec:
  selector:
    matchLabels:
      app: frontend
  template:
    meta
      labels:
        app: frontend
    spec:
      containers:
      - name: nginx
        image: nginx
---
apiVersion: v1
kind: Service
meta
  name: frontend
spec:
  selector:
    app: frontend
  ports:
  - port: 80

```

```yaml
# backend.yaml
apiVersion: apps/v1
kind: Deployment
meta
  name: backend
  labels:
    app: backend
spec:
  selector:
    matchLabels:
      app: backend
  template:
    meta
      labels:
        app: backend
    spec:
      containers:
      - name: httpd
        image: httpd

```

Apply:

```bash
kubectl apply -f frontend.yaml -f backend.yaml

```

âœ… **Right now**: `frontend` can `curl <http://backend`> â†’ **allowed**

---

### ğŸ§ª Step 2: Apply a NetworkPolicy to Restrict Access

```yaml
# deny-all-backend.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
meta
  name: deny-all-to-backend
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: backend   # â† Applies to Pods with this label
  policyTypes:
  - Ingress          # â† Control incoming traffic
  ingress: []        # â† Empty = deny ALL

```

Apply:

```bash
kubectl apply -f deny-all-backend.yaml

```

Now test:

```bash
# From frontend Pod
kubectl exec deploy/frontend -- curl -m 3 <http://backend>
# âŒ Connection timed out!

```

âœ… **Result**: Backend is now **isolated** â€” no one can reach it!

---

### âœ… Summary YAML

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
meta
  name: my-policy
spec:
  podSelector:
    matchLabels:
      app: target-pod
  policyTypes:
  - Ingress    # incoming
  - Egress     # outgoing (optional)
  ingress: []  # empty = deny all

```

> ğŸ”‘ Key Fields:
> 
> - `podSelector`: Which Pods does this policy apply to?
> - `policyTypes`: `Ingress`, `Egress`, or both
> - `ingress/egress`: Rules to **allow** traffic (empty = deny all)

---

### â“ Common Questions

**Q: Does NetworkPolicy work by default in k3s?**

â¡ï¸ âŒ **No!** k3s uses **Flannel** by default, which **does not support NetworkPolicy**.

âœ… **Fix**: Install a **CNI that supports NetworkPolicy**, like:

- **Cilium** (recommended)
- **Calico**
- **Weave Net**

> ğŸ’¡ For this chapter, weâ€™ll assume youâ€™ve installed Cilium:
> 
> 
> ```bash
> k3s-uninstall.sh  # if needed
> curl -L --remote-name <https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz>
> tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin
> cilium install
> 
> ```
> 

**Q: What if I donâ€™t apply any NetworkPolicy?**

â¡ï¸ All Pods can communicate freely (open network).

**Q: Are NetworkPolicies additive or restrictive?**

â¡ï¸ **Restrictive**: You start with **full access**, then **add policies to restrict**.

---

### ğŸ› ï¸ Best Practices

1. âœ… **Start with â€œdefault denyâ€**:
    
    ```yaml
    # Deny all ingress in namespace
    spec:
      podSelector: {}
      policyTypes: ["Ingress"]
      ingress: []
    
    ```
    
2. âœ… **Apply policies per namespace** (e.g., `dev`, `prod`)
3. âœ… **Label Pods clearly** (`app: frontend`, `tier: backend`)
4. âœ… **Test with `kubectl exec` + `curl`** before deploying to prod
5. âœ… **Use `policyTypes` explicitly** â€” donâ€™t rely on implicit behavior