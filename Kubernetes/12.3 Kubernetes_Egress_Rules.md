# **12.3 : Control Outgoing Traffic (Egress Rules)**

### ğŸ¯ What It Is

An **egress rule** in a NetworkPolicy lets you **restrict which external destinations a Pod can talk to** â€” for example, â€œbackend can only call the database, not the internet.â€

> âœ… This is critical for security compliance and preventing data exfiltration.
> 

### ğŸ’¡ Real-World Analogy

> Like a corporate firewall:
> 
> - Dev laptops can access **internal Git**, **CI/CD**, and **package repos**
> - But **not social media or random websites**

---

### ğŸ§ª Example: Allow Backend to Talk Only to Database

**Assume you have:**

- A `backend` Deployment (`app: backend`)
- A `database` Deployment (`app: database`)
- **Cilium or Calico** installed (NetworkPolicy enabled)

**Step 1: Apply a NetworkPolicy to Restrict Egress from Backend**

```yaml
# restrict-backend-egress.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
meta
  name: backend-egress-policy
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: backend          # â† Policy applies to backend Pods
  policyTypes:
  - Egress                  # â† Control outgoing traffic
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: database     # â† Only allow traffic to database Pods
    ports:
    - protocol: TCP
      port: 5432            # â† PostgreSQL port

```

Apply it:

```bash
kubectl apply -f restrict-backend-egress.yaml

```

**Step 2: Test Outgoing Traffic**

âœ… **From backend â†’ database (should work):**

```bash
kubectl exec deploy/backend -- nc -zv database 5432
# âœ… Succeeded

```

âŒ **From backend â†’ internet (should fail):**

```bash
kubectl exec deploy/backend -- wget -qO- <http://example.com> --timeout=3
# âŒ Connection timed out

```

âœ… **Result**: Backend is **locked down** â€” can only talk to the database!

---

### âœ… Summary YAML

```yaml
spec:
  podSelector:
    matchLabels:
      app: restricted-pod
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: allowed-destination
    ports:
    - port: 5432

```

> ğŸ”‘ Key Fields:
> 
> - `policyTypes: [Egress]` â†’ enables egress control
> - `egress.to.podSelector` â†’ which Pods can be reached
> - `egress.ports` â†’ which ports are allowed

---

### â“ Common Questions

**Q: Can I allow traffic to external IPs (outside the cluster)?**

âœ… Yes! Use `ipBlock`:

```yaml
egress:
- to:
  - ipBlock:
      cidr: 10.0.0.0/8
- to:
  - ipBlock:
      cidr: 0.0.0.0/0
      except:
      - 192.168.0.0/16

```

**Q: What if I donâ€™t specify `policyTypes: Egress`?**

â¡ï¸ Egress rules are **ignored** â€” all outgoing traffic is allowed.

**Q: Does egress policy affect DNS?**

âš ï¸ **Yes!** If you block all egress, Pods canâ€™t resolve `database` â†’ use `coredns` IP or allow DNS:

```yaml
egress:
- ports:
  - port: 53
    protocol: UDP

```

**Q: Can I combine ingress and egress in one policy?**

âœ… Yes!

```yaml
policyTypes:
- Ingress
- Egress
ingress: [...]
egress: [...]

```

---

### ğŸ› ï¸ Best Practices

1. âœ… **Start with deny-all egress**, then allow only whatâ€™s needed
2. âœ… **Allow DNS (port 53)** if using service names
3. âœ… **Use `ipBlock` for external dependencies** (e.g., AWS APIs, package repos)
4. âœ… **Label internal services clearly** (`app: database`, `tier: cache`)
5. âœ… **Test with `nc`, `wget`, or `curl`** from inside the Pod