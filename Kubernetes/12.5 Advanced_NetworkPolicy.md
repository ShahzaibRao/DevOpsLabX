# 12.5 : Advanced Rules â€“ NamespaceSelector & IP Blocks**

### ğŸ¯ What It Is

**Advanced NetworkPolicy rules** let you:

- Allow traffic **from specific namespaces** (using `namespaceSelector`)
- Allow traffic **to external IPs/networks** (using `ipBlock`)

> âœ… Essential for multi-team clusters, hybrid cloud, or compliance (e.g., â€œonly finance namespace can access payroll DBâ€).
> 

### ğŸ’¡ Real-World Analogy

> Like a corporate network with VLANs:
> 
> - **Finance VLAN** can talk to **Payroll Server**
> - **Dev VLAN** can talk to **CI/CD and package repos (10.0.0.0/8)**
> - **No cross-talk** between teams

---

### ğŸ§ª Example 1: Allow Traffic Only from `frontend` Namespace

**Assume:**

- `backend` Pods in `prod` namespace (`app: backend`)
- `frontend` Pods in `frontend` namespace (`app: frontend`)
- Both namespaces labeled: `team: web`

**Step 1: Label Namespaces**

```bash
kubectl label ns frontend team=web
kubectl label ns prod team=web

```

**Step 2: Create NetworkPolicy in `prod`**

```yaml
# allow-frontend-ns-to-backend.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
meta
  name: allow-frontend-ns
  namespace: prod
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          team: web        # â† Only namespaces with this label
      podSelector:
        matchLabels:
          app: frontend    # â† And Pods with this label
    ports:
    - port: 80

```

âœ… **Result**: Only Pods in **namespaces labeled `team=web`** AND with `app=frontend` can reach `backend`.

---

### ğŸ§ª Example 2: Allow Egress to External Package Repo (IP Block)

**Allow `build` Pods to reach internal package repo (`10.10.0.0/16`)**

```yaml
# allow-egress-to-repo.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
meta
  name: allow-package-repo
  namespace: ci
spec:
  podSelector:
    matchLabels:
      app: builder
  policyTypes:
  - Egress
  egress:
  - to:
    - ipBlock:
        cidr: 10.10.0.0/16
    ports:
    - protocol: TCP
      port: 80
  # Also allow DNS
  - ports:
    - port: 53
      protocol: UDP

```

âœ… **Result**: Builder Pods can download packages from `10.10.x.x`, but **not the public internet**.

---

### âœ… Summary YAML

```yaml
# Allow from specific namespace + pod
ingress:
- from:
  - namespaceSelector:
      matchLabels:
        env: prod
    podSelector:
      matchLabels:
        app: frontend

# Allow to external IP range
egress:
- to:
  - ipBlock:
      cidr: 10.0.0.0/8
      except:           # optional
      - 10.100.0.0/16

```

> ğŸ”‘ Key Fields:
> 
> - `namespaceSelector`: filters **source namespaces**
> - `ipBlock.cidr`: allows **external IP ranges**
> - `ipBlock.except`: excludes subnets from the CIDR

---

### â“ Common Questions

**Q: Can I use `namespaceSelector` without `podSelector`?**

âœ… Yes! Allows **all Pods** in matching namespaces:

```yaml
from:
- namespaceSelector:
    matchLabels:
      env: trusted

```

**Q: Does `ipBlock` work for ingress (incoming from outside)?**

âŒ **No!** Kubernetes **doesnâ€™t support ingress from external IPs via NetworkPolicy**.

âœ… Use **firewalls, cloud security groups, or Ingress controllers** for that.

**Q: What CIDR covers the entire internet?**

â¡ï¸ `0.0.0.0/0` â€” but **avoid it** (defeats the purpose of egress control).

**Q: Can I allow traffic to a Service IP?**

âŒ No! NetworkPolicy works on **Pod IPs**, not ClusterIPs.

âœ… Target the **Pods behind the Service** using labels.

---

### ğŸ› ï¸ Best Practices

1. âœ… **Label namespaces** (`team: dev`, `env: prod`) for easy policy management
2. âœ… Use `ipBlock` for **on-prem dependencies** (DBs, repos, APIs)
3. âœ… **Avoid `0.0.0.0/0`** â€” whitelist only necessary external IPs
4. âœ… **Combine `namespaceSelector` + `podSelector`** for least privilege
5. âœ… **Test with `kubectl run` + `curl`** from different namespaces

---