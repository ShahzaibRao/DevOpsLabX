# 12.6 : Troubleshooting & Best Practices for Network Policies**

### ğŸ¯ What It Is

Even with correct YAML, NetworkPolicies can **fail silently**. This topic covers **how to debug** and **apply production-grade practices**.

> âœ… Goal: Go from â€œwhy isnâ€™t this working?â€ to â€œtraffic flows exactly as intended.â€
> 

### ğŸ’¡ Real-World Analogy

> Like a network engineer with a packet sniffer:
> 
> - You donâ€™t guess â€” you **observe, test, and verify**
> - You have a **checklist** for common failures

---

### ğŸ§ª Step-by-Step Troubleshooting Guide

### ğŸ” **Step 1: Confirm Your CNI Supports NetworkPolicy**

```bash
# Check if Cilium/Calico is running
kubectl get pods -n kube-system | grep -E 'cilium|calico'

# If using Flannel (default in k3s) â†’ NetworkPolicy **wonâ€™t work!**

```

âœ… **Fix**: Install **Cilium**:

```bash
curl -L --remote-name <https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz>
tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin
cilium install

```

---

### ğŸ” **Step 2: Verify Policy Is Applied to the Right Pods**

```bash
# Check if policy matches your Pod labels
kubectl describe netpol my-policy

# List Pods that should be affected
kubectl get pods -l app=backend

```

âœ… **Common mistake**: Typo in labels (`app: backned` vs `app: backend`)

---

### ğŸ” **Step 3: Test Connectivity Manually**

```bash
# Start a debug Pod in the same namespace
kubectl run debug --image=busybox --rm -it -- sh

# Test ingress: can others reach target?
/ # wget -qO- <http://backend> --timeout=3

# Test egress: can target reach others?
kubectl exec deploy/backend -- wget -qO- <http://database> --timeout=3

```

âœ… **Use `--timeout`** to avoid hanging

---

### ğŸ” **Step 4: Check for Missing DNS or Port Rules**

```yaml
# If using service names, allow DNS!
egress:
- ports:
  - port: 53
    protocol: UDP

```

âŒ Without this, `curl <http://backend`> fails (canâ€™t resolve name)

---

### ğŸ” **Step 5: Use Cilium CLI for Deep Inspection (If Using Cilium)**

```bash
# Show effective policies for a Pod
cilium identity get -l app=backend

# Trace a connection attempt
cilium policy trace --src-identity <src-id> --dst-identity <dst-id>

```

---

### âœ… Summary: NetworkPolicy Best Practices Checklist

| Area | Best Practice |
| --- | --- |
| **CNI** | Use **Cilium** or **Calico** (not Flannel) |
| **Labels** | Label **Pods** and **Namespaces** consistently (`app`, `team`, `env`) |
| **Start Secure** | Apply **default-deny** in every production namespace |
| **Least Privilege** | Allow only required **ports**, **Pods**, and **namespaces** |
| **DNS** | Always allow **port 53** if using service names |
| **External Traffic** | Use `ipBlock` for on-prem dependencies (avoid `0.0.0.0/0`) |
| **Testing** | Validate with **debug Pods** before deploying apps |
| **Observability** | Use **Cilium Hubble** or **Calico Enterprise** for traffic visibility |

---

### â“ Common Questions

**Q: Why does my Pod work locally but fail in cluster?**

â¡ï¸ Likely missing **DNS** or **NetworkPolicy blocks egress**.

**Q: Can NetworkPolicy block traffic from outside the cluster?**

âŒ No! Use **cloud firewalls**, **load balancer rules**, or **Ingress controllers**.

**Q: Do NetworkPolicies apply to Services?**

âŒ No! They apply to **Pods** â€” Services are just DNS aliases.

**Q: What if I delete a NetworkPolicy?**

âœ… Traffic reverts to **fully open** (unless another policy exists).

---

### ğŸ› ï¸ Pro Tips for k3s Users

1. **Replace Flannel with Cilium**:
    
    ```bash
    curl -L --remote-name <https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz>
    tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin
    k3s-uninstall.sh  # if needed
    cilium install
    
    ```
    
2. **Test with minimal policies first**:
    
    ```yaml
    # Allow only frontend â†’ backend on port 80
    ingress:
    - from:
      - podSelector: { matchLabels: { app: frontend } }
      ports: [{ port: 80 }]
    
    ```
    
3. **Use `kubectl describe netpol`** to see applied rules.

---

## ğŸ Chapter 09 Complete! ğŸ‰

You now know how to:

- âœ… Isolate Pods with **default-deny policies**
- âœ… Allow traffic with **ingress/egress rules**
- âœ… Control cross-namespace traffic with **namespaceSelector**
- âœ… Restrict external access with **ipBlock**
- âœ… **Troubleshoot** like a pro

---