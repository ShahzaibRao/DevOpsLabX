# 13.2 : Ingress Controllers ‚Äì Traefik in k3s (Your Traffic Router)**

### üéØ What It Is

An **Ingress Controller** is a **Pod (or set of Pods)** that **watches Ingress resources** and **configures a load balancer** (like Traefik, Nginx, or HAProxy) to route traffic accordingly.

> ‚úÖ Ingress = configuration
> 
> 
> üîå **Ingress Controller = the engine that enforces it**
> 

### üí° Real-World Analogy

> Like a smart receptionist with a digital directory:
> 
> - Reads the **Ingress rules** (‚Äúmarketing ‚Üí floor 3‚Äù)
> - **Physically routes** visitors to the right office
> - Updates routing **in real-time** when rules change

---

### üß™ Example: Use k3s‚Äôs Built-in Traefik Controller

**Good news!** ‚úÖ **k3s includes Traefik by default** ‚Äî no extra install needed!

**Step 1: Deploy Two Sample Apps**

```yaml
# web.yaml
apiVersion: apps/v1
kind: Deployment
meta
  name: web
spec:
  replicas: 1
  selector:
    matchLabels:
      app: web
  template:
    meta
      labels:
        app: web
    spec:
      containers:
      - name: nginx
        image: nginx
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
meta
  name: web
spec:
  selector:
    app: web
  ports:
  - port: 80

```

```yaml
# api.yaml
apiVersion: apps/v1
kind: Deployment
meta
  name: api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api
  template:
    meta
      labels:
        app: api
    spec:
      containers:
      - name: httpd
        image: httpd
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
meta
  name: api
spec:
  selector:
    app: api
  ports:
  - port: 80

```

Apply:

```bash
kubectl apply -f web.yaml -f api.yaml

```

**Step 2: Create an Ingress (as in Topic 1)**

```yaml
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
meta
  name: main-ingress
spec:
  rules:
  - host: web.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: web
            port:
              number: 80
  - host: api.example.com
    http:
      paths:
      - path: /v1
        pathType: Prefix
        backend:
          service:
            name: api
            port:
              number: 80

```

Apply:

```bash
kubectl apply -f ingress.yaml

```

**Step 3: Get the Ingress IP and Test**

```bash
# Get Traefik's LoadBalancer IP (in k3s, it's the node IP)
kubectl get svc -n kube-system | grep traefik
# NAME      TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)
# traefik   LoadBalancer   10.43.123.45    192.168.1.100   80:32456/TCP

# Test with curl (simulate DNS via Host header)
curl -H "Host: web.example.com" <http://192.168.1.100>
# ‚úÖ Returns nginx welcome page

curl -H "Host: api.example.com" <http://192.168.1.100/v1>
# ‚úÖ Returns Apache welcome page

```

‚úÖ **Result**: Traefik **automatically configured itself** based on your Ingress!

---

### ‚úÖ Summary YAML

> üîë No extra YAML needed for Traefik in k3s!
> 
> 
> Just create your **Ingress resource** ‚Äî Traefik does the rest.
> 

To **disable Traefik** (if you want Nginx instead):

```bash
# Start k3s with:
k3s server --disable traefik

```

Then install Nginx Ingress Controller:

```bash
kubectl apply -f <https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.10.0/deploy/static/provider/cloud/deploy.yaml>

```

---

### ‚ùì Common Questions

**Q: How do I know if Traefik is running?**

```bash
kubectl get pods -n kube-system | grep traefik

```

**Q: What if `EXTERNAL-IP` is `<pending>`?**

‚û°Ô∏è In bare-metal k3s, **`EXTERNAL-IP` = node IP**. Use `kubectl get nodes -o wide` to find it.

**Q: Can I use custom domains in dev?**

‚úÖ Yes! Edit your **local `/etc/hosts`**:

```
192.168.1.100 web.example.com api.example.com

```

**Q: Does Traefik support TLS?**

‚úÖ Yes! (Next topic)

---

### üõ†Ô∏è Best Practices

1. ‚úÖ **Use k3s‚Äôs built-in Traefik** for dev/testing
2. ‚úÖ For production, consider **Nginx Ingress** (more features) or **Cilium L7 Gateway**
3. ‚úÖ Always test with **`curl -H "Host: ..."`** if DNS isn‚Äôt set up
4. ‚úÖ Monitor Traefik logs:
    
    ```bash
    kubectl logs -n kube-system -l app.kubernetes.io/name=traefik
    
    ```
    
5. ‚úÖ Use **Ingress annotations** for advanced features (rate limiting, auth, etc.)