# 13.3 : TLS with Ingress (HTTPS Made Easy)**

### üéØ What It Is

**TLS (Transport Layer Security)** encrypts traffic between users and your apps. In Kubernetes, you enable HTTPS on Ingress using a **TLS certificate** (from Let‚Äôs Encrypt, your CA, or self-signed for dev).

> ‚úÖ Why?
> 
> - Security: Prevents eavesdropping/man-in-the-middle
> - Compliance: Required for PCI, HIPAA, etc.
> - SEO: Google ranks HTTPS sites higher

### üí° Real-World Analogy

> Like a sealed envelope vs a postcard:
> 
> - HTTP = postcard (anyone can read it)
> - HTTPS = sealed envelope (only recipient can open)

---

### üß™ Example: Add HTTPS to Your Ingress (k3s + Traefik)

**Step 1: Create a TLS Secret (Self-Signed for Dev)**

```bash
# Generate a private key + self-signed cert
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \\
  -keyout tls.key -out tls.crt \\
  -subj "/CN=web.example.com"

# Create Kubernetes Secret
kubectl create secret tls web-tls-secret \\
  --key tls.key \\
  --cert tls.crt

```

> üîí For production: Use cert-manager + Let‚Äôs Encrypt (covered in best practices).
> 

**Step 2: Update Your Ingress to Use TLS**

```yaml
# ingress-tls.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
meta
  name: main-ingress
spec:
  tls:                          # ‚Üê Add TLS section
  - hosts:
    - web.example.com
    secretName: web-tls-secret  # ‚Üê Reference the Secret
  rules:
  - host: web.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: web
            port:
              number: 80

```

Apply:

```bash
kubectl apply -f ingress-tls.yaml

```

**Step 3: Test HTTPS**

```bash
# Get Traefik IP (same as before)
INGRESS_IP=$(kubectl get svc -n kube-system traefik -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

# Test with curl (ignore self-signed cert warning)
curl -k <https://web.example.com> --resolve web.example.com:443:$INGRESS_IP
# ‚úÖ Returns nginx welcome page over HTTPS!

```

‚úÖ **Result**: Your app is now served over **encrypted HTTPS**!

---

### ‚úÖ Summary YAML

```yaml
# TLS Secret
kubectl create secret tls my-tls-secret --key tls.key --cert tls.crt

# Ingress with TLS
spec:
  tls:
  - hosts: ["myapp.com"]
    secretName: my-tls-secret
  rules:
  - host: myapp.com
    http: ...

```

> üîë Key Points:
> 
> - `tls.secretName` must reference a **`kubernetes.io/tls` Secret**
> - The cert must be valid for the `hosts` listed

---

### ‚ùì Common Questions

**Q: Can I use one cert for multiple hosts?**

‚úÖ Yes! Use a **wildcard cert** (`*.example.com`) or **multi-SAN cert**.

**Q: Does Traefik auto-reload certs?**

‚úÖ Yes! If you update the Secret, Traefik reloads it automatically.

**Q: What if I don‚Äôt have a real domain?**

‚û°Ô∏è For dev, use **self-signed certs** + `curl -k` or add to system trust store.

**Q: How to redirect HTTP ‚Üí HTTPS?**

‚úÖ Use **Traefik middleware** (k3s-specific):

```yaml
# middleware.yaml
apiVersion: traefik.io/v1alpha1
kind: Middleware
meta
  name: redirect-https
spec:
  redirectScheme:
    scheme: https
    permanent: true

```

Then reference it in Ingress annotations:

```yaml
meta
  annotations:
    traefik.ingress.kubernetes.io/router.middlewares: default-redirect-https@kubernetess

```

---

### üõ†Ô∏è Best Practices

1. ‚úÖ **For production, use cert-manager + Let‚Äôs Encrypt**:
    
    ```yaml
    # Certificate CR (cert-manager)
    apiVersion: cert-manager.io/v1
    kind: Certificate
    meta
      name: web-cert
    spec:
      secretName: web-tls-secret
      issuerRef:
        name: letsencrypt-prod
        kind: ClusterIssuer
      dnsNames:
      - web.example.com
    
    ```
    
2. ‚úÖ **Never commit TLS keys to Git** ‚Äî use CI/CD or external secrets
3. ‚úÖ **Use strong ciphers** (Traefik/Nginx default is usually fine)
4. ‚úÖ **Test with SSL Labs**: https://www.ssllabs.com/ssltest/
5. ‚úÖ **Always redirect HTTP ‚Üí HTTPS** in production