# 13.4 : Path-Based Routing & Advanced Ingress Rules**

### üéØ What It Is

**Path-based routing** allows a single domain to serve **multiple apps** based on the URL path ‚Äî e.g.,

- `myapp.com/` ‚Üí frontend
- `myapp.com/api` ‚Üí backend API
- `myapp.com/docs` ‚Üí documentation site

> ‚úÖ This is essential for microservices, monorepos, and cost-efficient hosting.
> 

### üí° Real-World Analogy

> Like a shopping mall directory:
> 
> - ‚Äú**Shoes**‚Äù ‚Üí Floor 1
> - ‚Äú**Electronics**‚Äù ‚Üí Floor 2
> - Same entrance (`myapp.com`), different destinations

---

### üß™ Example: Route Paths to Different Services

**Assume you have:**

- `frontend` Service (`app: frontend`)
- `api` Service (`app: api`)
- `docs` Service (`app: docs`)

**Step 1: Create an Ingress with Path Rules**

```yaml
# path-routing.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
meta
  name: app-ingress
spec:
  rules:
  - host: myapp.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 80

      - path: /api
        pathType: Prefix
        backend:
          service:
            name: api
            port:
              number: 80

      - path: /docs
        pathType: Prefix
        backend:
          service:
            name: docs
            port:
              number: 80

```

Apply it:

```bash
kubectl apply -f path-routing.yaml

```

**Step 2: Test the Paths**

```bash
# Get Ingress IP (Traefik in k3s)
INGRESS_IP=$(kubectl get svc -n kube-system traefik -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

# Add to /etc/hosts (for local testing)
echo "$INGRESS_IP myapp.com" | sudo tee -a /etc/hosts

# Test paths
curl <http://myapp.com/>        # ‚Üí frontend
curl <http://myapp.com/api>     # ‚Üí api
curl <http://myapp.com/docs>    # ‚Üí docs

```

‚úÖ **Result**: One domain, three apps ‚Äî cleanly separated by path!

---

### üß™ Advanced: Exact vs Prefix Matching

| `pathType` | Example | Matches |
| --- | --- | --- |
| **`Prefix`** | `/api` | `/api`, `/api/v1`, `/api/users` |
| **`Exact`** | `/api` | **Only** `/api` |

> ‚úÖ Use Prefix for APIs, Exact for single-page routes.
> 

```yaml
paths:
- path: /healthz
  pathType: Exact
  backend:
    service:
      name: api
      port:
        number: 80

```

---

### ‚úÖ Summary YAML

```yaml
spec:
  rules:
  - host: myapp.com
    http:
      paths:
      - path: /          # Prefix = /
        pathType: Prefix
        backend: { ... }
      - path: /api       # Prefix = /api*
        pathType: Prefix
        backend: { ... }
      - path: /healthz   # Exact = only /healthz
        pathType: Exact
        backend: { ... }

```

> üîë Key Tip:
> 
> 
> Order **does not matter** ‚Äî Kubernetes matches the **longest path first**.
> 

---

### ‚ùì Common Questions

**Q: What if no path matches?**

‚û°Ô∏è Returns **404 Not Found** (Traefik/Nginx default).

**Q: Can I rewrite the path before sending to the service?**

‚úÖ **Yes!** But it requires **Ingress Controller-specific annotations**:

**For Traefik (k3s):**

```yaml
meta
  annotations:
    traefik.ingress.kubernetes.io/router.middlewares: default-stripprefix@kubernetess
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
meta
  name: stripprefix
spec:
  stripPrefix:
    prefixes:
    - /api

```

**For Nginx:**

```yaml
meta
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  rules:
  - http:
      paths:
      - path: /api(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: api
            port:
              number: 80

```

**Q: Do paths support regex?**

‚ùå Not in standard Ingress. Use **Ingress Controller extensions** (Nginx regex, Traefik middleware).

---

### üõ†Ô∏è Best Practices

1. ‚úÖ **Use `Prefix` for most paths** (flexible and intuitive)
2. ‚úÖ **Reserve `Exact` for health checks or single endpoints**
3. ‚úÖ **Group related paths under one host** (cleaner config)
4. ‚úÖ **Test path order** ‚Äî longest match wins
5. ‚úÖ **Use middleware for path rewriting** (don‚Äôt rely on app to handle `/api/v1`)