# 13.5 : Ingress Annotations & Controller-Specific Features**

### ğŸ¯ What It Is

**Ingress annotations** let you unlock **advanced features** of your Ingress Controller (like TLS redirect, rate limiting, authentication) that arenâ€™t part of the standard Kubernetes Ingress spec.

> âœ… Why?
> 
> 
> The base Ingress API is **minimal** â€” annotations add **real-world functionality**.
> 

### ğŸ’¡ Real-World Analogy

> Like custom settings on a smart thermostat:
> 
> - Basic mode: just heat/cool
> - Advanced mode: schedule, geofencing, energy reports
> - You enable extras via **settings (annotations)**

---

### ğŸ§ª Example 1: HTTP â†’ HTTPS Redirect (Traefik in k3s)

**Step 1: Create a Middleware (Traefik CRD)**

```yaml
# redirect-https.yaml
apiVersion: traefik.io/v1alpha1
kind: Middleware
meta
  name: redirect-https
  namespace: default
spec:
  redirectScheme:
    scheme: https
    permanent: true

```

**Step 2: Reference It in Ingress via Annotation**

```yaml
# ingress-with-redirect.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
meta
  name: secure-ingress
  annotations:
    traefik.ingress.kubernetes.io/router.middlewares: default-redirect-https@kubernetess
spec:
  tls:
  - hosts: ["myapp.com"]
    secretName: my-tls-secret
  rules:
  - host: myapp.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: web
            port:
              number: 80

```

âœ… **Result**: All HTTP traffic â†’ **301 redirect to HTTPS**

---

### ğŸ§ª Example 2: Rate Limiting (Nginx Ingress)

```yaml
# nginx-rate-limit.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
meta
  name: rate-limited-ingress
  annotations:
    nginx.ingress.kubernetes.io/limit-rps: "5"        # 5 requests/sec
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "2"
spec:
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /v1
        pathType: Prefix
        backend:
          service:
            name: api
            port:
              number: 80

```

âœ… **Result**: API is protected from **brute-force or DDoS**.

---

### ğŸ§ª Example 3: Basic Auth (Nginx)

```bash
# Create auth file
htpasswd -c auth admin
kubectl create secret generic basic-auth --from-file=auth

```

```yaml
# ingress-with-auth.yaml
meta
  annotations:
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: basic-auth
    nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"

```

âœ… **Result**: Pop-up login before accessing the app.

---

### âœ… Summary: Common Annotations

| Feature | Traefik (k3s) | Nginx |
| --- | --- | --- |
| **TLS Redirect** | `traefik.ingress.kubernetes.io/router.middlewares` | `nginx.ingress.kubernetes.io/ssl-redirect: "true"` |
| **Rate Limit** | Custom middleware | `nginx.ingress.kubernetes.io/limit-rps` |
| **Basic Auth** | Custom middleware | `nginx.ingress.kubernetes.io/auth-type` |
| **Custom Headers** | `traefik.http.middlewares.myheader.headers.customResponseHeaders` | `nginx.ingress.kubernetes.io/configuration-snippet` |

> ğŸ”‘ Key Rule:
> 
> 
> Annotations are **controller-specific** â€” **Traefik â‰  Nginx**.
> 

---

### â“ Common Questions

**Q: Where do I find annotation docs?**

â¡ï¸ **Traefik**: https://doc.traefik.io/traefik/routing/providers/kubernetes-ingress/

â¡ï¸ **Nginx**: https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/

**Q: What if I use the wrong annotation?**

â¡ï¸ Itâ€™s **ignored silently** â€” no error. Test thoroughly!

**Q: Can I use multiple middlewares in Traefik?**

âœ… Yes! Comma-separated:

```yaml
annotations:
  traefik.ingress.kubernetes.io/router.middlewares: default-redirect-https@kubernetess,default-ratelimit@kubernetess

```

**Q: Do annotations work with Gateway API?**

â¡ï¸ **Not directly** â€” Gateway API uses **first-class CRDs** instead of annotations (next chapter).

---

### ğŸ› ï¸ Best Practices

1. âœ… **Know your Ingress Controller** â€” donâ€™t mix Traefik + Nginx annotations
2. âœ… **Test in dev first** â€” annotations fail silently
3. âœ… **Use Helm values** (if using Helm chart) for global settings
4. âœ… **Document custom annotations** in your teamâ€™s runbook
5. âœ… **Prefer Gateway API** for new projects (cleaner, standardized)