# 4.1 : CPU Request Too High â€“ Scheduling Failure

https://drive.google.com/file/d/1aCCxjiwfzxO8R3911myUQtRO7HMZNr2B/view?usp=sharing

### ğŸ” YAML Breakdown

```yaml
apiVersion: v1
kind: Pod
metadata: 
  name: nnappone
  namespace: learning
  labels:
    app: nnappone
spec:
  containers:
    - name: crackone-app
      image: nginx
      resources:
        requests:
          cpu: "4"    # â† Wants 4 full CPU cores
        limits:
          cpu: "4"    # â† Also limits to 4 cores

```

> âš ï¸ Key Issue:
> 
> 
> The Pod requests **4 CPU cores** â€” but **most dev clusters (Minikube, Kind, Docker Desktop) have only 2â€“4 CPUs TOTAL**, and **system pods (kube-system) already use some**.
> 

> ğŸš« Result: No node has 4 free CPUs â†’ Pod canâ€™t be scheduled.
> 

---

### ğŸ“Œ What Happens During Scheduling?

1. **You run**: `kubectl apply -f pod-with-cpu-exceed.yml`
2. **Scheduler checks all nodes**:
â†’ *"Does any node have â‰¥4 CPU cores **available**?"*
3. **Answer**: âŒ **No** â†’ Pod stays in **`Pending`** state forever.
4. **Event logged**: `0/1 nodes are available: 1 Insufficient cpu.`

> ğŸ’¡ Important:
> 
> 
> This is a **scheduling failure** â€” **not a runtime crash**.
> 
> The container **never starts**.
> 

---

### ğŸ§ª Lab: Reproduce & Diagnose CPU Scheduling Failure

### ğŸ”§ Steps

```bash
# 1. Create namespace
kubectl create namespace learning

# 2. Apply the Pod
kubectl apply -f pod-with-cpu-exceed.yml

# 3. Check Pod status
kubectl get pods -n learning

# âœ… Expected output:
# NAME       READY   STATUS    RESTARTS   AGE
# nnappone   0/1     Pending   0          10s

# 4. Describe Pod â†’ look for scheduling events
kubectl describe pod nnappone -n learning

# ğŸ” Look for this critical line in "Events":
#   Type     Reason            Age   From               Message
#   ----     ------            ----  ----               -------
#   Warning  FailedScheduling  5s    default-scheduler  0/1 nodes are available: 1 Insufficient cpu.

```

### ğŸ” Check Your Nodeâ€™s Capacity

```bash
# See total & allocatable CPU on nodes
kubectl describe nodes | grep -A 5 -B 5 "Capacity\\|Allocatable"

# Example output (Minikube with 2 CPUs):
# Capacity:
#  cpu:                2
# Allocatable:
#  cpu:                2

```

> ğŸ“Š Allocatable CPU = Total CPU â€“ reserved for system/kubelet
> 
> 
> â†’ If allocatable = 2, you **canâ€™t schedule a 4-CPU Pod**.
> 

---

### ğŸ› ï¸ How to Fix It?

### âœ… Option 1: Reduce CPU Request (Recommended for Labs)

```yaml
resources:
  requests:
    cpu: "500m"   # 0.5 CPU
  limits:
    cpu: "1000m"  # 1.0 CPU

```

### âœ… Option 2: Add More CPU to Your Cluster

- **Minikube**: `minikube start --cpus=6`
- **Kind**: Edit config to request more CPUs
- **Cloud**: Use a larger node instance

### âœ… Option 3: Delete Other Workloads

Free up CPU by removing unused Pods:

```bash
kubectl delete pod --all --all-namespaces

```

---

### â“ Common Questions

**Q: Why does it say "Insufficient cpu" even if my laptop has 8 cores?**

A: Kubernetes only sees **whatâ€™s allocated to the cluster**.

- Minikube default = **2 CPUs**
- Docker Desktop Kubernetes = **2 CPUs** (configurable in settings)

**Q: Will it ever run if I wait?**

A: âŒ **No** â€” unless a node with 4+ free CPUs joins the cluster.

**Q: What if I set only `limits` (no `requests`)?**

A: Kubernetes copies `limits` â†’ `requests`, so same problem!

**Q: Can I force it to run?**

A: **Not safely.** You could use **taints/tolerations** or **scheduler policies**, but that risks **node instability**.

---

### ğŸ“Š Real-World Best Practices

| Practice | Why |
| --- | --- |
| **Right-size requests** | Use monitoring (Prometheus) to measure real usage |
| **Set requests < limits** | Allows bursting (Burstable QoS) |
| **Avoid `:latest` + huge requests** | Double risk: image pull + scheduling failure |
| **Use `kubectl top nodes`** | See real-time CPU/memory usage |

```bash
# Check current resource usage
kubectl top nodes
kubectl top pods --all-namespaces

```

---

### â¡ï¸ Summary

âœ… **Scheduling fails** if `requests` > available node capacity.

ğŸ” Diagnose with: `kubectl describe pod` â†’ look for **"Insufficient cpu"**.

ğŸ“Š Check node capacity with: `kubectl describe nodes`.

ğŸ› ï¸ Fix by: **reducing requests** or **adding node capacity**.

ğŸš« This is **not a container crash** â€” itâ€™s a **pre-start failure**.