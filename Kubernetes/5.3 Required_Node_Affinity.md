# 5.3 : Required Node Affinity

https://drive.google.com/file/d/1cuVfdChjbHgUh_AM2IMQmiVq6iKwGx-D/view?usp=sharing

### ğŸ” YAML Breakdown

```yaml
apiVersion: v1
kind: Pod
meta
  name: nnappone
  namespace: learning
  labels:
    app: nnappone
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:  # â† HARD constraint
        nodeSelectorTerms:
        - matchExpressions:
          - key: size
            operator: In
            values:
            - small
  containers:
    - name: crackone-app
      image: nginx
      resources:
        requests:
          memory: "300Mi"
        limits:
          memory: "500Mi"

```

> ğŸ”‘ Key Section:
> 
> 
> `requiredDuringSchedulingIgnoredDuringExecution` â†’ **must match at schedule time**, but **wonâ€™t evict** if node label changes later.
> 

> ğŸ¯ Rule:
> 
> 
> *"Only schedule this Pod on nodes where label `size` is **in** the list `[small]`."*
> 

---

### ğŸ“Œ How Node Affinity Works

| Term | Meaning |
| --- | --- |
| **`requiredDuringScheduling...`** | **Hard requirement** â€” like `nodeSelector`, but more powerful |
| **`nodeSelectorTerms`** | List of **OR** conditions (Pod matches if **any term** matches) |
| **`matchExpressions`** | List of **AND** conditions (all must match within a term) |
| **`operator: In`** | Value must be in the list (`values: [small]`) |

> ğŸ’¡ Other Operators:
> 
> - `NotIn` â†’ exclude values
> - `Exists` â†’ key must exist (any value)
> - `DoesNotExist` â†’ key must not exist
> - `Gt`, `Lt` â†’ for numeric labels (e.g., `cores > 4`)

---

### ğŸ†š `nodeSelector` vs `requiredDuringScheduling...`

| Feature | `nodeSelector` | `required nodeAffinity` |
| --- | --- | --- |
| **Logic** | Only `key=value` (AND only) | Supports `In`, `NotIn`, `Exists`, etc. |
| **Multiple values** | âŒ No | âœ… Yes (`values: [small, medium]`) |
| **Multiple keys (OR)** | âŒ No | âœ… Yes (multiple `nodeSelectorTerms`) |
| **Readability** | Simple | More verbose, but more powerful |
| **Future-proof** | Legacy | **Recommended by Kubernetes** |

> âœ… Kubernetes Docs:
> 
> 
> *"We recommend using `nodeAffinity` instead of `nodeSelector`."*
> 

---

### ğŸ§ª Lab: Deploy Pod with Required Node Affinity

### ğŸ”§ Step 1: Label a Node

```bash
# 1. Get node name
kubectl get nodes

# 2. Label a node as "small"
kubectl label node minikube size=small

# 3. Verify
kubectl get nodes --show-labels | grep size

```

### ğŸ”§ Step 2: Deploy the Pod

```bash
# 1. Create namespace
kubectl create namespace learning

# 2. Apply Pod
kubectl apply -f pod-with-required-node-affinity.yml

# 3. Check placement
kubectl get pods -n learning -o wide

# âœ… Should run on node with size=small

# 4. Describe Pod â†’ see affinity rules
kubectl describe pod nnappone -n learning | grep -A 5 "Node Affinity"

```

> ğŸ” Expected in describe:
> 
> 
> ```
> Node-Selectors:  <none>
> Node Affinity:   requiredDuringSchedulingIgnoredDuringExecution
>   Term 1:        size in [small]
> 
> ```
> 

### ğŸ”§ Step 3: Test Failure (No Matching Node)

```bash
# Remove label
kubectl label node minikube size-

# Redeploy Pod
kubectl apply -f pod-with-required-node-affinity.yml

# Check status
kubectl get pods -n learning
# â†’ STATUS = Pending

kubectl describe pod nnappone -n learning
# Events: 0/1 nodes match node affinity

```

### ğŸ”§ Step 4: Clean Up

```bash
kubectl delete pod nnappone -n learning
kubectl label node minikube size-  # if still labeled
kubectl delete namespace learning

```

---

### ğŸ’¡ Real-World Example: Multi-Zone + Instance Type

```yaml
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
      - matchExpressions:
        - key: topology.kubernetes.io/zone
          operator: In
          values: [us-east-1a, us-east-1b]
        - key: node.kubernetes.io/instance-type
          operator: In
          values: [m5.large, m5.xlarge]

```

> âœ… Meaning:
> 
> 
> "Run in **zone A or B**, on **m5.large or m5.xlarge** instances."
> 

---

### â“ Common Questions

**Q: What does "IgnoredDuringExecution" mean?**

A: If you **change the node label after scheduling**, the Pod **wonâ€™t be evicted**.

â†’ For **dynamic re-scheduling**, youâ€™d need a **custom controller** (not built-in).

**Q: Can I use both `nodeSelector` and `nodeAffinity`?**

A: âœ… Yes! Theyâ€™re **ANDed together**. But **donâ€™t do it** â€” use only `nodeAffinity`.

**Q: What if I have multiple `matchExpressions` in one term?**

A: Theyâ€™re **ANDed**:

```yaml
- matchExpressions:
  - key: size; operator: In; values: [small]
  - key: disk; operator: In; values: [ssd]
# â†’ Node must have BOTH labels

```

---

### â¡ï¸ Summary

âœ… **`requiredDuringScheduling...`** = **hard constraint** (like `nodeSelector`, but better).

âœ… Supports **rich operators**: `In`, `NotIn`, `Exists`, etc.

âœ… Use **`nodeSelectorTerms`** for **OR logic**, **`matchExpressions`** for **AND logic**.

ğŸ” Verify with: `kubectl describe pod` â†’ **"Node Affinity"** section.

ğŸš« **Never evicted** if node labels change later.