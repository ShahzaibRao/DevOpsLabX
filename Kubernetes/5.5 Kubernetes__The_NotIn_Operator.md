# 5.5: Excluding Nodes with `NotIn` Affinity

https://drive.google.com/file/d/1uLx1C0J4Kul69fUwDoBwNXvcFP7eQU2L/view?usp=sharing

### ğŸ” YAML Breakdown

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nnappone
  namespace: learning
  labels:
    app: nnappone
spec:
  containers:
    - name: crackone-app
      image: nginx
      resources:
        requests:
          memory: "300Mi"
        limits:
          memory: "500Mi"
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: size
            operator: NotIn        # â† EXCLUDE these values
            values:
            - small

```

> ğŸ”‘ Key Rule:
> 
> 
> *"Do **NOT** schedule this Pod on any node where label `size` is **`small`**."*
> 

> âœ… Important:
> 
> 
> This **does NOT require** the `size` label to exist!
> 
> - If a node **has no `size` label** â†’ it **matches** (because `size` is **not** `small`)
> - Only nodes with `size=small` are **excluded**

---

### ğŸ“Œ How `NotIn` Works

| Node Label | Matches `NotIn [small]`? | Why? |
| --- | --- | --- |
| `size=small` | âŒ No | Explicitly excluded |
| `size=large` | âœ… Yes | Not in exclusion list |
| `size=medium` | âœ… Yes | Not in exclusion list |
| **No `size` label** | âœ… Yes | Key doesnâ€™t exist â†’ canâ€™t be `small` |

> ğŸ’¡ This is different from In:
> 
> - `In [small]` â†’ **requires** the label to exist and match
> - `NotIn [small]` â†’ **only excludes** if label exists **and** matches

---

### ğŸ§ª k3s Lab: Exclude `small` Nodes

> âœ… Assumption: You have 2+ worker nodes in your k3s cluster.
> 

### ğŸ”§ Step 1: Label Nodes (One as `small`, One as `large`)

```bash
# 1. List nodes
kubectl get nodes

# 2. Label nodes
kubectl label node k3s-node1 size=small
kubectl label node k3s-node2 size=large

# 3. Verify
kubectl get nodes --show-labels | grep size

```

### ğŸ”§ Step 2: Deploy the Pod

```bash
# 1. Create namespace
kubectl create namespace learning

# 2. Apply Pod
kubectl apply -f pod-with-node-affinity-cannot.yml

# 3. Check placement
kubectl get pods -n learning -o wide

# âœ… Expected: Runs on k3s-node2 (size=large)
# âŒ Will NOT run on k3s-node1 (size=small)

```

### ğŸ”§ Step 3: Test Edge Case â€” **All Nodes Are `small`**

> ğŸ’¡ What if every node is labeled size=small?
> 

```bash
# 1. Relabel k3s-node2 as "small"
kubectl label node k3s-node2 size=small --overwrite

# 2. Deploy a new Pod
kubectl run test-pod -n learning --image=nginx --restart=Never \\
  --overrides='
{
  "spec": {
    "affinity": {
      "nodeAffinity": {
        "requiredDuringSchedulingIgnoredDuringExecution": {
          "nodeSelectorTerms": [
            {
              "matchExpressions": [
                {
                  "key": "size",
                  "operator": "NotIn",
                  "values": ["small"]
                }
              ]
            }
          ]
        }
      }
    }
  }
}'

# 3. Check status
kubectl get pods -n learning
# â†’ STATUS = Pending

# 4. Describe to see why
kubectl describe pod test-pod -n learning
# Events: 0/2 nodes are available: 2 node(s) didn't match Pod's node affinity rules.

```

> ğŸ” Key Insight:
> 
> 
> If **all nodes are excluded**, Pod **stays Pending forever** â€” just like a `required` affinity with no match.
> 

---

### ğŸ› ï¸ Real-World Use Cases for `NotIn`

| Scenario | Affinity Rule |
| --- | --- |
| **Avoid dev nodes** | `env NotIn (dev, test)` |
| **Skip GPU nodes for CPU jobs** | `accelerator NotIn (nvidia, amd)` |
| **Donâ€™t run on master** | `node-role.kubernetes.io/master NotIn (true)` |
| **Exclude spot instances** | `lifecycle NotIn (spot)` |

> âœ… Pro Tip: Combine with taints for stronger isolation:
> 
> - Taint dev nodes: `kubectl taint node dev-node env=dev:NoSchedule`
> - Then use `NotIn` as a **double-check**

---

### â“ Common Questions

**Q: What if a node has no `size` label?**

A: âœ… It **matches** `NotIn [small]` â€” because the key doesnâ€™t exist, so it canâ€™t be `small`.

**Q: Can I exclude multiple values?**

A: âœ… Yes!

```yaml
operator: NotIn
values: [small, dev, test]

```

**Q: Is `NotIn` the same as `DoesNotExist`?**

A: âŒ No!

- `NotIn [small]` â†’ excludes only `size=small`
- `operator: DoesNotExist` â†’ only matches nodes **without** the `size` label

**Q: What if I use `NotIn` with `preferred` affinity?**

A: It becomes a **soft exclusion** â€” scheduler will **avoid** those nodes but may use them if needed.

**Q: Does this work with control-plane nodes?**

A: âœ… Yes â€” but remember: k3s control-plane nodes have **taints** by default. You may need to **tolerate** them or **remove taints**.

---

### â¡ï¸ Summary

âœ… **`operator: NotIn`** = **exclude nodes** with specific label values.

âœ… Nodes **without the label** are **allowed** (not excluded).

âš ï¸ If **all nodes are excluded**, Pod **stays Pending**.

ğŸ” Use for: **isolation**, **cost control**, **security boundaries**.

ğŸ› ï¸ In k3s: Works perfectly across multi-node clusters.