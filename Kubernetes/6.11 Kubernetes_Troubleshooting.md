# 6.11: Troubleshooting Deployments & Services

https://drive.google.com/file/d/1egvAeNLA0xnF15gRdJm4SYII1XIr68m8/view?usp=sharing

---

### ğŸ” Issue 1: Service Selector Mismatch (`tshoot-deployment.yaml`)

### âŒ The Problem

```yaml
# Deployment labels
template:
  metadata:
    labels:
      app: nginx        # â† Pods have "app: nginx"

# Service selector
spec:
  selector:
    app: ngimx          # â† TYPO! Should be "nginx"

```

> ğŸš¨ Result:
> 
> - Service exists, but **Endpoints = `<none>`**
> - `curl http://<service-ip>` â†’ **connection timeout**

### ğŸ”§ Diagnosis Steps (k3s)

```bash
# 1. Deploy the broken YAML
kubectl apply -f tshoot-deployment.yaml

# 2. Check Service Endpoints
kubectl get endpoints nginx-deployment-service
# NAME                        ENDPOINTS   AGE
# nginx-deployment-service    <none>      10s  â† NO PODS!

# 3. Verify Pod labels
kubectl get pods --show-labels
# Labels: app=nginx

# 4. Verify Service selector
kubectl get svc nginx-deployment-service -o yaml | grep -A 2 selector
# selector:
#   app: ngimx  â† TYPO!

# 5. Test connectivity (will hang/time out)
kubectl run debug --image=curlimages/curl -it --rm -- sh
# curl <http://nginx-deployment-service>  â† hangs

```

### âœ… Fix

```yaml
# Correct the Service selector
spec:
  selector:
    app: nginx   # â† Fixed typo

```

> ğŸ’¡ Pro Tip: Always use kubectl get endpoints <service> to verify Pod linkage.
> 

---

### ğŸ” Issue 2: Incomplete Service Definition (`tshoot-deployment-svc.yaml`)

### âŒ The Problem

```yaml
apiVersion: apps/v1
kind: Deployment
meta
  name: nginx-deployment
  # ... (valid Deployment)
---
# âŒ NO SERVICE DEFINED IN YAML!
# Only a comment: "expose this deployment with a service..."

```

> ğŸš¨ Result:
> 
> - Deployment runs, but **no Service exists**
> - No way to access Pods (except direct Pod IP)

### ğŸ”§ Diagnosis Steps (k3s)

```bash
# 1. Apply the YAML (only creates Deployment)
kubectl apply -f tshoot-deployment-svc.yaml

# 2. Check for Services
kubectl get svc
# No service named "my-nginx-web-svc"!

# 3. Try to access (fails)
kubectl run debug --image=curlimages/curl -it --rm -- sh
# curl <http://my-nginx-web-svc>  â† "Could not resolve host"

```

### âœ… Fix Options

### Option A: Create Service via CLI (as comment suggests)

```bash
kubectl expose deployment nginx-deployment \\
  --name=my-nginx-web-svc \\
  --port=80 \\
  --target-port=80

```

### Option B: Add Service to YAML (production best practice)

```yaml
---
apiVersion: v1
kind: Service
meta
  name: my-nginx-web-svc
spec:
  selector:
    app: nginx          # â† Must match Deployment labels
  ports:
  - port: 80
    targetPort: 80

```

---

### ğŸ› ï¸ Universal Troubleshooting Checklist

| Symptom | Diagnostic Command | Likely Cause |
| --- | --- | --- |
| **Service timeout** | `kubectl get endpoints <svc>` | Selector mismatch |
| **"Host not found"** | `kubectl get svc` | Service not created |
| **Pods not ready** | `kubectl describe pod <pod>` | Liveness/readiness probe failure |
| **Image pull error** | `kubectl describe pod <pod>` | Bad image name/tag |
| **Pending Pods** | `kubectl describe pod <pod>` | Insufficient resources / taints |

> ğŸ’¡ Golden Rule:
> 
> 
> **Service selector MUST match Pod labels exactly** (case-sensitive, no typos!).
> 

---

### ğŸ§ª k3s Lab: Fix Both Issues

### ğŸ”§ Step 1: Reproduce Issue 1 (Selector Mismatch)

```bash
# Apply broken YAML
kubectl apply -f tshoot-deployment.yaml

# Confirm broken endpoints
kubectl get endpoints nginx-deployment-service  # <none>

# Fix by patching Service
kubectl patch svc nginx-deployment-service -p '{"spec":{"selector":{"app":"nginx"}}}'

# Verify fix
kubectl get endpoints nginx-deployment-service  # Now shows Pod IPs

```

### ğŸ”§ Step 2: Reproduce Issue 2 (Missing Service)

```bash
# Apply incomplete YAML
kubectl apply -f tshoot-deployment-svc.yaml

# Create Service manually
kubectl expose deployment nginx-deployment \\
  --name=my-nginx-web-svc --port=80 --target-port=80

# Test
kubectl run debug --image=curlimages/curl -it --rm -- sh
# curl <http://my-nginx-web-svc>  # âœ… Works!

```

### ğŸ”§ Step 3: Clean Up

```bash
kubectl delete -f tshoot-deployment.yaml
kubectl delete -f tshoot-deployment-svc.yaml
kubectl delete svc my-nginx-web-svc  # if created manually

```

---

### ğŸ’¡ Pro Tips for k3s

1. **Always verify Endpoints**:
    
    ```bash
    kubectl get ep <service-name>
    
    ```
    
2. **Use `-dry-run=client` to test selectors**:
    
    ```bash
    kubectl create service clusterip test --tcp=80:80 --dry-run=client -o yaml
    
    ```
    
3. **Label consistency**: Use the same labels in:
    - Deployment `spec.template.metadata.labels`
    - Service `spec.selector`

---

### â“ Common Questions

**Q: What if my Pod has multiple labels?**

A: Service selector must match **at least the specified labels** (extra labels on Pod are OK).

**Q: Can I use `matchExpressions` in Service selector?**

A: âŒ **No!** Services only support `matchLabels` (simple key-value).

**Q: Why does `kubectl expose` work but my YAML doesnâ€™t?**

A: `kubectl expose` **auto-copies labels** from Deployment â†’ less error-prone.

**Q: How to prevent typos in selectors?**

A: âœ… **Use YAML linters**

âœ… **Copy-paste labels** from Deployment to Service

âœ… **Use GitOps** with PR reviews

---

### â¡ï¸ Summary

âœ… **Service selector must EXACTLY match Pod labels**

âœ… **Always check `kubectl get endpoints`** to verify linkage

âœ… **Incomplete YAML = missing resources**

ğŸ” In k3s: Debug with `describe`, `get endpoints`, and `curl` from debug Pod

ğŸ› ï¸ **Fix typos** with `kubectl patch` or corrected YAML