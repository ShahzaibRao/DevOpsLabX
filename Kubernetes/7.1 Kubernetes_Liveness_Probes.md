# 7.1: Liveness Probes (Auto-Restart Unhealthy Pods)

https://drive.google.com/file/d/1ovRvqFddKp74eItuM_PUL61xBU4vIzsV/view?usp=sharing

### ğŸ” YAML Breakdown

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nnwebserver
spec:
  containers:
    - name: nnwebserver
      image: lovelearnlinux/webserver:v1
      livenessProbe:
        exec:
          command: ["cat", "/var/www/html/index.html"]  # â† Check if file exists
        initialDelaySeconds: 10   # â† Wait 10s before first check
        timeoutSeconds: 3         # â† Fail if check takes >3s
        periodSeconds: 20         # â† Repeat every 20s
        failureThreshold: 3       # â† Fail 3 times â†’ restart container
      resources:
        requests:
          cpu: "500m"
          memory: "128Mi"
        limits:
          cpu: "1000m"
          memory: "256Mi"
      ports:
        - containerPort: 80

```

> ğŸ”‘ Key Insight:
> 
> 
> This probe **restarts the container** if `/var/www/html/index.html` is missing or unreadable.
> 

---

### ğŸ“Œ How Liveness Probes Work

| Parameter | Purpose | Your Value |
| --- | --- | --- |
| **`exec.command`** | Run command inside container | `cat /var/www/html/index.html` |
| **`initialDelaySeconds`** | Wait before first probe | `10s` (lets app start) |
| **`periodSeconds`** | How often to probe | `20s` |
| **`failureThreshold`** | Consecutive failures before restart | `3` |
| **`timeoutSeconds`** | Max time for probe to complete | `3s` |

> ğŸ¯ Failure Timeline:
> 
> - `t=10s`: First probe
> - If fails â†’ `t=30s`: Second probe
> - If fails â†’ `t=50s`: Third probe
> - If fails â†’ **container restarted** at `t=50s`

> ğŸ’¡ Probe Types:
> 
> - **`exec`**: Run command (your example)
> - **`httpGet`**: HTTP request (e.g., `GET /health`)
> - **`tcpSocket`**: Open TCP connection (for non-HTTP apps)

---

### ğŸ§ª k3s Lab: Break the App & Watch Auto-Restart

### ğŸ”§ Step 1: Deploy the Pod

```bash
# Apply Pod
kubectl apply -f pod-with-health-check.yml

# Verify it's running
kubectl get pods nnwebserver

```

### ğŸ”§ Step 2: Simulate App Failure

> ğŸ’¡ Delete the critical file that the probe checks:
> 

```bash
# Remove index.html (breaks the app)
kubectl exec nnwebserver -- rm /var/www/html/index.html

```

### ğŸ”§ Step 3: Watch Kubernetes Heal Itself

```bash
# Watch Pod restarts
kubectl get pods nnwebserver -w

# âœ… Expected:
# NAME          READY   STATUS    RESTARTS   AGE
# nnwebserver   1/1     Running   0          10s
# nnwebserver   1/1     Running   1          45s  â† Restarted!

# Check logs to confirm
kubectl describe pod nnwebserver | grep -A 5 "Liveness"
# Events:
#   Warning  Unhealthy  50s  kubelet  Liveness probe failed: cat: /var/www/html/index.html: No such file or directory
#   Normal   Killing    50s  kubelet  Container nnwebserver failed liveness probe, will be restarted

```

> ğŸ” Why did it restart?
> 
> - Probe failed 3 times (`failureThreshold: 3`)
> - Kubernetes **killed and restarted** the container
> - New container recreates `/var/www/html/index.html` (assuming image does this on startup)

### ğŸ”§ Step 4: Clean Up

```bash
kubectl delete pod nnwebserver

```

---

### ğŸ’¡ Real-World Liveness Probe Examples

| App Type | Probe Command |
| --- | --- |
| **Web Server** | `httpGet: { path: /health, port: 80 }` |
| **Database** | `exec: { command: ["pg_isready", "-h", "localhost"] }` |
| **Queue Worker** | `tcpSocket: { port: 6379 }` (Redis) |
| **Custom App** | `exec: { command: ["/app/health-check.sh"] }` |

> âœ… Best Practices:
> 
> - **Donâ€™t use liveness probe for startup delays** â†’ use `initialDelaySeconds`
> - **Make probe lightweight** â†’ avoid heavy DB queries
> - **Test failure scenarios** â†’ ensure restart actually fixes the issue

---

### â“ Common Questions

**Q: Whatâ€™s the difference between liveness and readiness probes?**

A:

- **Liveness**: "Is the app alive?" â†’ **restart if dead**
- **Readiness**: "Is the app ready for traffic?" â†’ **remove from Service if not ready**

**Q: Can I use both probes together?**

A: âœ… **Yes!** (Youâ€™ll see this in `pod-readiness-liveness-probes`)

**Q: What if the probe command doesnâ€™t exist in the container?**

A: Probe fails â†’ container restarts (check `kubectl describe pod` for `executable file not found`)

**Q: Does restarting the container lose data?**

A: âš ï¸ **Yes!** If data is stored in the container filesystem (not PersistentVolume).

âœ… **Fix**: Use **PersistentVolumes** for stateful apps.

---

### â¡ï¸ Summary

âœ… **Liveness probe** = auto-restart unhealthy containers

âœ… **`failureThreshold: 3`** = 3 consecutive failures before restart

âœ… **`exec` probe** = run command inside container

ğŸ” In k3s: Test by **deleting a critical file** â†’ watch restart

ğŸ› ï¸ Always set **realistic timeouts and delays**