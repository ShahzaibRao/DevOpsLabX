# 7.5: NodePort Service (External Access in k3s)

https://drive.google.com/file/d/1Z0gn4y0JFBx2YRg4a-zB9AsIr6RSfeTk/view?usp=sharing

### ğŸ” YAML Breakdown

```yaml
# Service
apiVersion: v1
kind: Service
metadata:
  name: nnweb-svc
  namespace: learning
  labels:
    app: hello-nn
spec:
  type: NodePort          # â† Exposes on ALL node IPs
  ports:
  - port: 80              # â† Service port (internal)
    nodePort: 30003       # â† Fixed external port (30000-32767)
    protocol: TCP
  selector:
    app: hello-nn         # â† Must match Deployment labels

---
# Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-deploy
  namespace: learning
spec:
  replicas: 2
  selector:
    matchLabels:
      app: hello-nn
  template:
    metadata:
      labels:
        app: hello-nn
    spec:
      containers:
      - name: webserver-pod
        image: lovelearnlinux/webserver:v1
        ports:
        - containerPort: 80

```

> ğŸ”‘ Key Insight:
> 
> - **NodePort Service** opens port `30003` on **every node** in the cluster
> - Traffic to `http://<ANY-NODE-IP>:30003` â†’ load-balanced to **Pods with `app: hello-nn`**

---

### ğŸ“Œ How NodePort Works in k3s

| Component | Role |
| --- | --- |
| **`type: NodePort`** | Tells Kubernetes to open a port on all nodes |
| **`nodePort: 30003`** | Fixed external port (optional; if omitted, k3s assigns random 30000-32767) |
| **`port: 80`** | Internal Service port (used by ClusterIP) |
| **`selector`** | Links to Pods (`app: hello-nn`) |
| **kube-proxy** | Configures **iptables rules** on each node to forward `:30003` â†’ Pods |

> ğŸ¯ Access Methods:
> 
> 1. **Internal**: `curl http://nnweb-svc.learning.svc:80` (from inside cluster)
> 2. **External**: `curl http://<NODE-IP>:30003` (from laptop, browser, etc.)

> ğŸ’¡ k3s Advantage:
> 
> 
> No cloud provider needed â€” **NodePort works out-of-the-box** on bare metal!
> 

---

### ğŸ§ª k3s Lab: Deploy + Test External Access

### ğŸ”§ Step 1: Deploy the Stack

```bash
# Create namespace
kubectl create namespace learning

# Apply Deployment + Service
kubectl apply -f service-nodeport.yml

# Verify
kubectl get deploy,svc,pods -n learning

```

### ğŸ”§ Step 2: Verify Endpoints

```bash
# Check Pod IPs linked to Service
kubectl get endpoints nnweb-svc -n learning

# âœ… Expected:
# NAME         ENDPOINTS                         AGE
# nnweb-svc    10.42.0.10:80,10.42.1.15:80       10s

```

### ğŸ”§ Step 3: Test Internal Access (ClusterIP)

```bash
# From a debug Pod
kubectl run debug -n learning --image=curlimages/curl -it --rm -- sh

# Inside shell:
curl <http://nnweb-svc:80>
# âœ… "Welcome to CrackOne!"

exit

```

### ğŸ”§ Step 4: Test External Access (NodePort)

> ğŸ’¡ Get k3s node IPs:
> 

```bash
kubectl get nodes -o wide
# NAME         STATUS   INTERNAL-IP
# k3s-master   Ready    192.168.1.10
# k3s-node1    Ready    192.168.1.11

```

> ğŸŒ From your laptop (or any machine with network access to k3s nodes):
> 

```bash
# Access via ANY node IP
curl <http://192.168.1.10:30003>
curl <http://192.168.1.11:30003>
# âœ… Both return the same welcome page!

```

> ğŸ” How it works:
> 
> - Request hits **any node**
> - kube-proxy forwards to **random Pod** (even if Pod is on another node!)

### ğŸ”§ Step 5: Clean Up

```bash
kubectl delete -f service-nodeport.yml
kubectl delete namespace learning

```

---

### ğŸ’¡ Real-World NodePort Best Practices

| Practice | Why |
| --- | --- |
| **Use fixed `nodePort`** (e.g., `30003`) | Easier firewall rules, documentation |
| **Restrict with firewall** | Only allow trusted IPs to `:30003` |
| **Prefer Ingress for HTTP/S** | Better routing, TLS termination, path-based rules |
| **Avoid for production public apps** | Use **LoadBalancer** (MetalLB) or **Ingress** instead |

> âœ… When to use NodePort:
> 
> - **Admin dashboards** (Prometheus, Grafana)
> - **Temporary external access** (testing, demos)
> - **Bare-metal clusters without MetalLB**

---

### ğŸ†š Service Types in k3s

| Type | External Access | Port Range | Use Case |
| --- | --- | --- | --- |
| **ClusterIP** | âŒ No | N/A | Internal microservices |
| **NodePort** | âœ… Yes | `30000-32767` | Dev/testing, admin tools |
| **LoadBalancer** | âœ… Yes | Any | Production (requires MetalLB) |

> ğŸ’¡ To get LoadBalancer in k3s:
> 
> 
> Install [MetalLB](https://metallb.io/) â†’ then `type: LoadBalancer` gives you a **real external IP**.
> 

---

### â“ Common Questions

**Q: What if I omit `nodePort`?**

A: k3s assigns a **random port** in `30000-32767` â†’ check with `kubectl get svc`.

**Q: Can I use ports outside 30000-32767?**

A: âŒ **No!** Kubernetes enforces this range (configurable at cluster level).

**Q: Does NodePort work if the Pod is on a different node?**

A: âœ… **Yes!** kube-proxy handles **cross-node forwarding**.

**Q: Is NodePort secure?**

A: âš ï¸ It exposes ports on **all nodes**.

âœ… **Always pair with**:

- Firewall rules
- Network Policies (if using CNI like Cilium)
- Authentication in the app

---

### â¡ï¸ Summary

âœ… **NodePort** = external access via **`<NODE-IP>:<30000-32767>`**

âœ… Works on **any k3s node IP** â€” traffic routed to Pods anywhere in cluster

âœ… **Fixed `nodePort`** = easier management

ğŸ” In k3s: Test with `curl http://<NODE-IP>:30003` from your laptop

ğŸ› ï¸ Use for **admin tools**, **testing** â€” prefer **Ingress/LoadBalancer** for production