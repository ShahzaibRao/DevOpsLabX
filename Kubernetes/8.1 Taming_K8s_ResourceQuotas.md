# 8.1 : Pod Quotas (Limit Number of Pods per Namespace)

https://drive.google.com/file/d/1RGZ_f7zoVbRyCoZe3_Wx4XX6DcLkApqH/view?usp=sharing

### ğŸ” YAML Breakdown

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: pod-quota
  namespace: learning    # â† Applied to this namespace only
spec:
  hard:
    pods: "4"            # â† Max 4 Pods allowed in "learning" namespace

```

> ğŸ”‘ Key Insight:
> 
> 
> This quota **prevents users/teams** from flooding a namespace with unlimited Pods â€” critical for **cost control and stability**.
> 

> ğŸ’¡ Why limit Pods?
> 
> - Each Pod consumes **IP addresses**, **kubelet resources**, **etcd space**
> - Prevents **"noisy neighbor"** attacks in multi-team clusters

---

### ğŸ“Œ How ResourceQuota Works

| Component | Role |
| --- | --- |
| **`namespace: learning`** | Quota applies **only to this namespace** |
| **`hard.pods: "4"`** | Hard limit â€” **no more than 4 Pods** (running + pending) |
| **Enforcement** | Happens at **admission time** (before Pod is created) |

> ğŸ¯ What counts toward pods quota?
> 
> - Every **Pod** (including those from Deployments, ReplicaSets, Jobs)
> - **Does NOT count**: Services, ConfigMaps, Secrets

> âš ï¸ Important:
> 
> 
> Quotas apply to **all Pods** in the namespace â€” even if created by controllers (Deployments, etc.).
> 

---

### ğŸ§ª k3s Lab: Enforce Pod Quota

### ğŸ”§ Step 1: Create Namespace & Apply Quota

```bash
# Create namespace
kubectl create namespace learning

# Apply quota
kubectl apply -f namespace-pod-quota.yml

# Verify quota
kubectl get resourcequotas -n learning
# NAME        AGE   REQUEST     LIMIT
# pod-quota   10s   pods: 0/4

```

### ğŸ”§ Step 2: Deploy Pods Up to Quota Limit

```bash
# Deploy 4 Pods (using bare Pods for simplicity)
for i in {1..4}; do
  kubectl run pod$i -n learning --image=nginx --restart=Never
done

# Verify
kubectl get pods -n learning
# 4 Pods in "Running" state
kubectl describe resourcequotas pod-quota -n learning
# Used: pods: 4

```

### ğŸ”§ Step 3: Exceed Quota (Watch Enforcement)

```bash
# Try to deploy a 5th Pod
kubectl run pod5 -n learning --image=nginx --restart=Never

# âœ… Expected error:
# Error from server (Forbidden):
# pods "pod5" is forbidden:
# exceeded quota: pod-quota, requested: pods=1, used: pods=4, limited: pods=4

```

> ğŸ” Key Message:
> 
> 
> **"exceeded quota"** â†’ Kubernetes **blocks creation** at admission time.
> 

### ğŸ”§ Step 4: Clean Up

```bash
# Delete all Pods
kubectl delete pod --all -n learning

# Delete quota
kubectl delete resourcequota pod-quota -n learning

# Delete namespace
kubectl delete namespace learning

```

---

### ğŸ’¡ Real-World Quota Use Cases

| Scenario | Quota Type |
| --- | --- |
| **Team namespace** | `pods: 20`, `requests.cpu: 10`, `requests.memory: 20Gi` |
| **CI/CD namespace** | `pods: 100` (for short-lived jobs) |
| **Production namespace** | Strict CPU/memory quotas + Pod limits |
| **Sandbox namespace** | Very low quotas (e.g., `pods: 5`) |

> âœ… Best Practices:
> 
> - **Always set quotas** in multi-tenant clusters
> - **Combine with LimitRanges** (next topic) to enforce resource requests
> - **Monitor quota usage**: `kubectl describe resourcequotas`

---

### ğŸ†š Quota Types Overview

| Quota | Example | Purpose |
| --- | --- | --- |
| **`pods`** | `pods: "10"` | Limit number of Pods |
| **`requests.cpu`** | `requests.cpu: "4"` | Total CPU requested |
| **`requests.memory`** | `requests.memory: "8Gi"` | Total memory requested |
| **`limits.cpu`** | `limits.cpu: "8"` | Total CPU limit |
| **`count/services`** | `count/services: "5"` | Limit number of Services |

---

### â“ Common Questions

**Q: Do Deployments respect Pod quotas?**

A: âœ… **Yes!** If you deploy a Deployment with `replicas: 10` but quota=4:

- Only **4 Pods** will be created
- Deployment stays in **`Available: False`** state

**Q: What if I delete a Pod?**

A: Quota usage **decreases immediately** â†’ you can create new Pods.

**Q: Can I have multiple ResourceQuota objects in one namespace?**

A: âŒ **No!** Only **one ResourceQuota** per namespace (but it can have many rules).

**Q: Does quota apply to system Pods (kube-system)?**

A: âŒ **No!** Quotas only apply to **user namespaces** (not `kube-system`, `default`, etc.).

---

### â¡ï¸ Summary

âœ… **`ResourceQuota`** = hard limits on namespace resources

âœ… **`pods: "4"`** = max 4 Pods (any type) in namespace

ğŸ” In k3s: Test by **exceeding quota** â†’ watch **"forbidden" error**

ğŸ› ï¸ Always set quotas in **multi-team clusters**