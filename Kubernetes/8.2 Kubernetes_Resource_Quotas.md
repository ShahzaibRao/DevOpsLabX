# 8.2: Resource Quotas (CPU & Memory Limits)

https://drive.google.com/file/d/132X_P0IKV-zSgNG3ocHXdnwv4ATGxMTz/view?usp=sharing

### ğŸ” YAML Breakdown

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: memory-cpu-quota
  namespace: learning
spec:
  hard:
    requests.cpu: "1"        # â† Total CPU requests â‰¤ 1 core
    requests.memory: 1Gi     # â† Total memory requests â‰¤ 1 GiB
    limits.cpu: "2"          # â† Total CPU limits â‰¤ 2 cores
    limits.memory: 2Gi       # â† Total memory limits â‰¤ 2 GiB

```

> ğŸ”‘ Key Insight:
> 
> 
> This quota enforces **four hard limits** on the `learning` namespace:
> 
> - **Total requested CPU** â‰¤ 1 core
> - **Total requested memory** â‰¤ 1 GiB
> - **Total CPU limits** â‰¤ 2 cores
> - **Total memory limits** â‰¤ 2 GiB

> ğŸ’¡ Why both requests and limits?
> 
> - **`requests`** â†’ used for **scheduling** and **quota allocation**
> - **`limits`** â†’ used for **runtime enforcement** (throttling/OOM)
> â†’ Both are **critical for fair resource sharing**

---

### ğŸ“Œ How Resource Quotas Work

| Quota Type | What It Tracks | Enforcement |
| --- | --- | --- |
| **`requests.cpu`** | Sum of all `resources.requests.cpu` in Pods | At **Pod creation** |
| **`requests.memory`** | Sum of all `resources.requests.memory` | At **Pod creation** |
| **`limits.cpu`** | Sum of all `resources.limits.cpu` | At **Pod creation** |
| **`limits.memory`** | Sum of all `resources.limits.memory` | At **Pod creation** |

> ğŸ¯ Example:
> 
> 
> If you deploy a Pod with:
> 
> ```yaml
> resources:
>   requests:
>     cpu: "500m"
>     memory: "512Mi"
>   limits:
>     cpu: "1000m"
>     memory: "1Gi"
> 
> ```
> 
> â†’ Quota usage becomes:
> 
> - `requests.cpu`: 0.5/1
> - `requests.memory`: 512Mi/1Gi
> - `limits.cpu`: 1/2
> - `limits.memory`: 1Gi/2Gi

> âš ï¸ Critical Rule:
> 
> 
> **Every container in every Pod must define `resources.requests` and `limits`** â€” otherwise, quota enforcement **fails silently** (Pod wonâ€™t be created).
> 

---

### ğŸ§ª k3s Lab: Enforce CPU/Memory Quotas

### ğŸ”§ Step 1: Create Namespace & Apply Quota

```bash
# Create namespace
kubectl create namespace learning

# Apply quota
kubectl apply -f namespace-resourcequota.yml

# Verify
kubectl describe resourcequotas memory-cpu-quota -n learning
# Hard:
#  limits.cpu:      2
#  limits.memory:   2Gi
#  requests.cpu:    1
#  requests.memory: 1Gi
# Used: <all 0>

```

### ğŸ”§ Step 2: Deploy a Pod Within Quota

```yaml
# pod-within-quota.yaml
apiVersion: v1
kind: Pod
meta
  name: good-pod
  namespace: learning
spec:
  containers:
  - name: nginx
    image: nginx
    resources:
      requests:
        cpu: "500m"
        memory: "512Mi"
      limits:
        cpu: "1000m"
        memory: "1Gi"

```

```bash
kubectl apply -f pod-within-quota.yaml

# Verify usage
kubectl describe resourcequotas memory-cpu-quota -n learning
# Used:
#  requests.cpu:    500m
#  requests.memory: 512Mi
#  limits.cpu:      1
#  limits.memory:   1Gi

```

### ğŸ”§ Step 3: Exceed Quota (Watch Enforcement)

### âŒ Case 1: Exceed `requests.memory`

```yaml
# pod-exceed-memory.yaml
apiVersion: v1
kind: Pod
metadata:
  name: bad-pod-memory
  namespace: learning
spec:
  containers:
  - name: nginx
    image: nginx
    resources:
      requests:
        memory: "1536Mi"  # > 1Gi quota (1024Mi used by good-pod)
      limits:
        memory: "2Gi"

```

```bash
kubectl apply -f pod-exceed-memory.yaml

# âœ… Expected error:
# Error from server (Forbidden):
# exceeded quota: memory-cpu-quota,
# requested: requests.memory=1536Mi,
# used: requests.memory=512Mi,
# limited: requests.memory=1Gi

```

### âŒ Case 2: Exceed `limits.cpu`

```yaml
# pod-exceed-cpu.yaml
apiVersion: v1
kind: Pod
meta
  name: bad-pod-cpu
  namespace: learning
spec:
  containers:
  - name: nginx
    image: nginx
    resources:
      requests:
        cpu: "500m"
      limits:
        cpu: "1500m"  # > 2 cores total (1 core used by good-pod)

```

```bash
kubectl apply -f pod-exceed-cpu.yaml

# âœ… Expected error:
# exceeded quota: memory-cpu-quota,
# requested: limits.cpu=1500m,
# used: limits.cpu=1,
# limited: limits.cpu=2

```

### ğŸ”§ Step 4: Clean Up

```bash
kubectl delete pod good-pod -n learning
kubectl delete resourcequota memory-cpu-quota -n learning
kubectl delete namespace learning

```

---

### ğŸ’¡ Real-World Quota Strategies

| Team | CPU Requests | Memory Requests | CPU Limits | Memory Limits |
| --- | --- | --- | --- | --- |
| **Frontend** | 4 cores | 8 GiB | 8 cores | 16 GiB |
| **Backend** | 8 cores | 16 GiB | 16 cores | 32 GiB |
| **Data Science** | 16 cores | 64 GiB | 32 cores | 128 GiB |
| **Sandbox** | 1 core | 2 GiB | 2 cores | 4 GiB |

> âœ… Best Practices:
> 
> - **Set `requests` = realistic baseline usage**
> - **Set `limits` = 2x `requests`** (for bursting)
> - **Monitor usage**: `kubectl describe resourcequotas`
> - **Combine with LimitRanges** (next topic) to auto-set defaults

---

### ğŸ†š Quota vs LimitRange

| Feature | **ResourceQuota** | **LimitRange** |
| --- | --- | --- |
| **Scope** | Namespace-wide totals | Per-Pod/container defaults |
| **Purpose** | "You can use **up to X**" | "If you donâ€™t specify, use **Y**" |
| **Enforcement** | Hard block at creation | Auto-applies defaults |
| **Use Together?** | âœ… **Yes!** (Quota + LimitRange = complete governance) |  |

> ğŸ’¡ Your next files (limit-ranges.yaml, etc.) will cover LimitRange.
> 

---

### â“ Common Questions

**Q: What if a Pod doesnâ€™t define `resources`?**

A: âŒ **Quota enforcement fails** â†’ Pod creation blocked with:

`failed quota: must specify limits.cpu,limits.memory,requests.cpu,requests.memory`

**Q: Do Deployments respect resource quotas?**

A: âœ… **Yes!** If total replicas exceed quota, **only some Pods are created**.

**Q: Can I set quotas on GPUs or custom resources?**

A: âœ… Yes! Example:

```yaml
hard:
  requests.nvidia.com/gpu: "4"

```

**Q: Does quota usage update in real-time?**

A: âœ… **Yes!** When Pods are created/deleted, usage updates immediately.

---

### â¡ï¸ Summary

âœ… **ResourceQuota** = hard limits on **total namespace resources**

âœ… **Track both `requests` and `limits`** for CPU/memory

ğŸ” In k3s: Test by **exceeding quota** â†’ watch **"forbidden" error**

ğŸ› ï¸ Always combine with **LimitRange** for complete governance

â¡ï¸ Next: **LimitRange defaults** (`limit-ranges.yaml`)