# 9.3: `hostPath` Volumes (Node Directory Mount)

https://drive.google.com/file/d/1KQZ7ejpCI7BREx_-qFwpC_C-U61NZU3-/view?usp=sharing

### ğŸ” YAML Breakdown

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nnappone
  namespace: learning
  labels:
    app: nnappone
spec:
  volumes:
    - name: "web-data"
      hostPath:
        path: "/tmp/webserver"   # â† Directory on the NODE
  containers:
    - name: networknuts-app
      image: lovelearnlinux/webserver:v1
      volumeMounts:
        - mountPath: "/var/www/html"  # â† Mounted in container
          name: "web-data"
      resources:
        requests:
          cpu: "400m"
          memory: "128Mi"
        limits:
          cpu: "500m"
          memory: "256Mi"
      ports:
        - containerPort: 80

```

> ğŸ”‘ Key Insight:
> 
> 
> `hostPath` mounts a **directory from the nodeâ€™s filesystem** into the Pod.
> 
> - Data **survives Pod deletion**
> - Data is **tied to a specific node**

> ğŸ’¡ Why /tmp/webserver?
> 
> - Easy to access on the node
> - Survives reboots (unlike `/tmp` on some systems)

---

### ğŸ“Œ When to Use `hostPath`

| Use Case | Why |
| --- | --- |
| **Single-node clusters** (k3s on laptop) | Simple persistent storage |
| **DaemonSets** (logging agents) | Access node logs (`/var/log`) |
| **System-level Pods** | Access node filesystem (e.g., CNI plugins) |

> âš ï¸ When NOT to use hostPath:
> 
> - **Multi-node clusters** â†’ Pod may reschedule to **another node** (data lost!)
> - **Production stateful apps** â†’ Use **PersistentVolumes** instead
> - **Security-sensitive workloads** â†’ `hostPath` can expose node filesystem

---

### ğŸ§ª k3s Lab: Test `hostPath` Persistence

### ğŸ”§ Step 1: Create Namespace & Deploy Pod

```bash
# Create namespace
kubectl create namespace learning

# Apply Pod
kubectl apply -f pod-with-volume.yml

# Verify
kubectl get pods -n learning -o wide
# Note the NODE where Pod is running (e.g., k3s-node1)

```

### ğŸ”§ Step 2: Write Data to the Volume

```bash
# Create a file in the Pod
kubectl exec nnappone -n learning -- sh -c "echo '<h1>Persistent via hostPath!</h1>' > /var/www/html/index.html"

# Verify
kubectl exec nnappone -n learning -- cat /var/www/html/index.html

```

### ğŸ”§ Step 3: Delete Pod (Data Survives on Node)

```bash
# Delete Pod
kubectl delete pod nnappone -n learning

# Check node filesystem (SSH into the node from Step 1)
ssh <node-ip>
cat /tmp/webserver/index.html
# âœ… "Persistent via hostPath!" â†’ data survived Pod deletion!

```

### ğŸ”§ Step 4: Recreate Pod (Data Still There)

```bash
# Redeploy Pod (may land on same node in single-node k3s)
kubectl apply -f pod-with-volume.yml

# Verify data is still served
kubectl port-forward nnappone -n learning 8080:80 &
curl <http://localhost:8080>
# âœ… "Persistent via hostPath!"

```

> âš ï¸ Critical Test: In a multi-node k3s cluster, if the new Pod lands on a different node, the data wonâ€™t be there!
> 

### ğŸ”§ Step 5: Clean Up

```bash
kubectl delete pod nnappone -n learning
kubectl delete namespace learning

# Optional: Clean up node directory
# ssh <node> && sudo rm -rf /tmp/webserver

```

---

### ğŸ’¡ Real-World `hostPath` Examples

| Scenario | Path | Why |
| --- | --- | --- |
| **Node logs** | `/var/log` | Fluentd DaemonSet ships logs |
| **Docker socket** | `/var/run/docker.sock` | CI/CD agents build images |
| **Kernel modules** | `/lib/modules` | Specialized workloads |

> âœ… Best Practices:
> 
> - **Only use in single-node clusters** (like k3s on laptop)
> - **Avoid in multi-node clusters** â†’ use **PersistentVolumes**
> - **Set `type: DirectoryOrCreate`** to auto-create directory:
>     
>     ```yaml
>     hostPath:
>       path: /tmp/webserver
>       type: DirectoryOrCreate
>     
>     ```
>     

---

### ğŸ†š `hostPath` vs Persistent Volumes

| Feature | **`hostPath`** | **PersistentVolume** |
| --- | --- | --- |
| **Node affinity** | âŒ Tied to one node | âœ… Can move with Pod (if supported) |
| **Multi-node safe** | âŒ No | âœ… Yes |
| **Admin effort** | Low (single-node) | Medium (NFS, cloud disks) |
| **Use Case** | Single-node dev, DaemonSets | Production stateful apps |

> ğŸ’¡ Your next files (persistent-volume-nfs.yaml, pvc-nfs.yaml) will cover true persistent storage.
> 

---

### â“ Common Questions

**Q: What if the directory doesnâ€™t exist on the node?**

A: âŒ Pod fails with `CreateContainerConfigError`.

âœ… **Fix**: Use `type: DirectoryOrCreate`.

**Q: Can I use `hostPath` with Deployments?**

A: âš ï¸ **Dangerous!** If Deployment scales to 2+ replicas, **all Pods try to use the same node directory** â†’ data corruption!

**Q: Is `hostPath` secure?**

A: âŒ **No!** It can expose the entire node filesystem.

âœ… **Fix**: Use **PodSecurityPolicy** or **Pod Security Standards** to restrict `hostPath`.

**Q: Does `hostPath` work with k3s?**

A: âœ… **Yes!** Perfect for **single-node k3s** (your use case).

---

### â¡ï¸ Summary

âœ… **`hostPath`** = mount **node directory** into Pod

âœ… **Data survives Pod deletion** (on the same node)

âš ï¸ **Not safe for multi-node clusters** (data tied to node)

ğŸ” In k3s: Great for **single-node persistence**

â¡ï¸ Next: **Persistent Volumes with NFS** (`persistent-volume-nfs.yaml`)