# 9.4: PersistentVolume (PV) with NFS

https://drive.google.com/file/d/1lCwC8hfi6bfx5-m4wwuS3NCtd31FjYct/view?usp=sharing

### üîç YAML Breakdown

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pvone-nfs
spec:
  capacity:
    storage: 5Gi                 # ‚Üê Total storage size
  volumeMode: Filesystem         # ‚Üê Standard filesystem (not block)
  accessModes:
    - ReadWriteOnce              # ‚Üê RWO: one node at a time
  persistentVolumeReclaimPolicy: Recycle  # ‚Üê What to do when PVC is deleted
  storageClassName: slow         # ‚Üê Links to StorageClass (optional)
  nfs:
    path: /foldername            # ‚Üê Exported directory on NFS server
    server: ip-address-nfs-server # ‚Üê NFS server IP/DNS

```

> üîë Key Insight:
> 
> 
> This PV represents **5Gi of shared storage** on an **NFS server**, accessible to **any Pod in the cluster** (as long as it‚Äôs on a node that can reach the NFS server).
> 

> üí° Why NFS?
> 
> - **Shared storage**: Multiple Pods can access the same data (with proper `accessModes`)
> - **Multi-node safe**: Data isn‚Äôt tied to a specific k3s node
> - **Cheap & simple**: Runs on any Linux server

---

### üìå Critical Concepts Explained

### 1. **`accessModes`**

| Mode | Meaning | NFS Support |
| --- | --- | --- |
| **`ReadWriteOnce` (RWO)** | Read-write by **one node** | ‚úÖ Yes |
| **`ReadOnlyMany` (ROX)** | Read-only by **many nodes** | ‚úÖ Yes |
| **`ReadWriteMany` (RWX)** | Read-write by **many nodes** | ‚úÖ **Yes!** (NFS‚Äôs superpower) |

> ‚ö†Ô∏è Your PV uses ReadWriteOnce ‚Üí but NFS supports ReadWriteMany!
> 
> 
> ‚úÖ **For shared storage (e.g., web servers)**, use `ReadWriteMany`.
> 

### 2. **`persistentVolumeReclaimPolicy`**

| Policy | Behavior |
| --- | --- |
| **`Retain`** | Keep PV + data (manual cleanup) |
| **`Delete`** | Delete PV + data (cloud disks) |
| **`Recycle`** | **Deprecated!** Runs `rm -rf` (unsafe) |

> üö® Critical Warning:
> 
> 
> **`Recycle` is deprecated since Kubernetes 1.11!**
> 
> ‚úÖ **Use `Retain`** (for NFS) or `Delete` (for cloud).
> 

### 3. **`storageClassName`**

- Links PV to a **StorageClass** (for dynamic provisioning)
- If **not set**, PV is **statically provisioned** (your case)

---

### üß™ k3s Lab: Test NFS PersistentVolume

> üí° Don‚Äôt have an NFS server?
> 
> 
> We‚Äôll use a **k3s node as NFS server** (for lab purposes).
> 

### üîß Step 1: Set Up NFS Server (On a k3s Node)

> üìù Run on one k3s node (e.g., k3s-master):
> 

```bash
# Install NFS server
sudo apt update && sudo apt install -y nfs-kernel-server

# Create shared directory
sudo mkdir -p /foldername
sudo chmod 777 /foldername

# Export directory
echo "/foldername *(rw,sync,no_subtree_check)" | sudo tee -a /etc/exports

# Restart NFS
sudo exportfs -a
sudo systemctl restart nfs-kernel-server

```

> üîç Get NFS server IP:
> 
> 
> ```bash
> ip addr show  # Note the node's IP (e.g., 192.168.1.10)
> 
> ```
> 

### üîß Step 2: Create PersistentVolume

> üí° Update YAML with real NFS server IP:
> 

```yaml
# persistent-volume-nfs.yaml (updated)
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pvone-nfs
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteMany        # ‚Üê Changed to RWX for shared access
  persistentVolumeReclaimPolicy: Retain  # ‚Üê Fixed deprecated policy
  storageClassName: slow   # ‚Üê Storage class name
  nfs:
    path: /nfs
    server: 192.168.1.10   # ‚Üê Your NFS server IP

```

```bash
# Apply PV
kubectl apply -f persistent-volume-nfs.yaml

# Verify
kubectl get pv
# NAME        CAPACITY  ACCESS MODES  RECLAIM POLICY  STATUS      CLAIM
# pvone-nfs   5Gi       RWX           Retain          Available   <none>

```

### üîß Step 3: Next Step ‚Äî Create PVC

> üí° PV is not usable yet ‚Äî you need a PersistentVolumeClaim (PVC) to bind to it.
> 

Your next file (`pvc-nfs.yaml`) will cover this!

### üîß Step 4: Clean Up (Later)

```bash
# Delete PV
kubectl delete pv pvone-nfs

# On NFS server:
sudo rm -rf /foldername
sudo sed -i '/foldername/d' /etc/exports
sudo exportfs -a

```

---

### üí° Real-World NFS PV Best Practices

| Setting | Recommendation |
| --- | --- |
| **`accessModes`** | Use `ReadWriteMany` for shared apps (web servers, CMS) |
| **`reclaimPolicy`** | **`Retain`** (NFS) or **`Delete`** (cloud) |
| **Permissions** | Set `chmod 777` or match Pod‚Äôs `runAsUser` |
| **Security** | Restrict NFS exports to k3s node IPs: |
| `/foldername 192.168.1.0/24(rw,sync)` |  |

> ‚úÖ Why NFS over hostPath?
> 
> - Works in **multi-node clusters**
> - **Shared access** (`ReadWriteMany`)
> - **Centralized management**

---

### üÜö Static vs Dynamic Provisioning

| Approach | How It Works | Your Case |
| --- | --- | --- |
| **Static PV** | Admin creates PV ‚Üí User creates PVC to claim it | ‚úÖ Your YAML |
| **Dynamic PV** | User creates PVC ‚Üí StorageClass auto-creates PV | `storage-class-nfs` (next topic) |

> üí° Static provisioning = manual, good for labs
> 
> 
> **Dynamic provisioning** = automated, good for production
> 

---

### ‚ùì Common Questions

**Q: What if NFS server is down?**

A: Pods **hang** on mount ‚Üí use **timeout settings** or **monitor NFS**.

**Q: Can I use NFS with StatefulSets?**

A: ‚úÖ **Yes!** Perfect for shared storage (e.g., WordPress + NFS).

**Q: Why is `Recycle` deprecated?**

A: It ran `rm -rf` as root ‚Üí **security risk**. Use `Retain` + manual cleanup.

**Q: Does k3s support NFS?**

A: ‚úÖ **Yes!** Just install `nfs-common` on all k3s nodes:

```bash
sudo apt install -y nfs-common

```

---

### ‚û°Ô∏è Summary

‚úÖ **PersistentVolume (PV)** = cluster-wide storage resource

‚úÖ **NFS** = shared, multi-node, `ReadWriteMany` storage

‚ö†Ô∏è **Avoid `Recycle`** ‚Üí use `Retain`

üîç In k3s: Set up **NFS server on a node** for labs

‚û°Ô∏è Next: **PersistentVolumeClaim (PVC)** to request storage (`pvc-nfs.yaml`)