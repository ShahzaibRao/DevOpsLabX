# 9.5: PersistentVolumeClaim (PVC) for NFS

https://drive.google.com/file/d/13qUv3XlMUR9SMbpzN_DJOvpYroTldbZ_/view?usp=sharing

### üîç YAML Breakdown

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: myclaim
spec:
  accessModes:
    - ReadWriteMany
  volumeMode: Filesystem
  resources:
    requests:
      storage: 4Gi
  storageClassName: slow

```

> üîë Key Insight:
> 
> 
> This PVC is a **storage request** that will **bind to a compatible PV** (like your `pvone-nfs`).
> 

> üí° How binding works:
> 
> 
> Kubernetes matches PVC to PV based on:
> 
> - `storageClassName` (must match)
> - `accessModes` (PVC modes ‚äÜ PV modes)
> - `storage` (PV capacity ‚â• PVC request)

---

### üìå PVC-PV Binding Rules

| Requirement | Your PVC | Your PV (`pvone-nfs`) | Match? |
| --- | --- | --- | --- |
| **`storageClassName`** | `slow` | `slow` | ‚úÖ Yes |
| **`accessModes`** | `ReadWriteOnce` | `ReadWriteOnce` | ‚úÖ Yes |
| **`storage`** | `4Gi` | `5Gi` | ‚úÖ Yes (5Gi ‚â• 4Gi) |

> ‚úÖ Result: PVC will bind to pvone-nfs ‚Üí status = Bound
> 

> ‚ö†Ô∏è Critical Note:
> 
> 
> Your PV uses **`ReadWriteOnce`**, but NFS supports **`ReadWriteMany`**.
> 
> ‚Üí If your app needs **shared access**, change **both** PVC and PV to `ReadWriteMany`.
> 

---

### üß™ k3s Lab: Bind PVC to NFS PV

### üîß Step 1: Ensure PV Exists

> üí° You should already have pvone-nfs from the previous lab:
> 

```bash
kubectl get pv
# NAME        CAPACITY  ACCESS MODES  STATUS      CLAIM
# pvone-nfs   5Gi       RWO           Available   <none>

```

### üîß Step 2: Apply PVC

```bash
# Apply PVC
kubectl apply -f pvc-nfs.yaml

# Verify binding
kubectl get pvc
# NAME      STATUS   VOLUME       CAPACITY  ACCESS MODES
# myclaim   Bound    pvone-nfs    5Gi       RWO

kubectl get pv
# NAME        STATUS   CLAIM
# pvone-nfs   Bound    default/myclaim

```

> üîç Key Observation:
> 
> - PVC status = **`Bound`**
> - PV is now **claimed** by `default/myclaim`

### üîß Step 3: Use PVC in a Pod

```yaml
# pod-using-pvc.yaml
apiVersion: v1
kind: Pod
metadata:
  name: nfs-pod
spec:
  containers:
  - name: web
    image: nginx
    volumeMounts:
    - mountPath: /usr/share/nginx/html
      name: nfs-storage
  volumes:
  - name: nfs-storage
    persistentVolumeClaim:
      claimName: myclaim  # ‚Üê Reference PVC

```

```bash
kubectl apply -f pod-using-pvc.yaml

# Write data
kubectl exec nfs-pod -- sh -c "echo '<h1>Hello from NFS!</h1>' > /usr/share/nginx/html/index.html"

# Delete Pod and recreate
kubectl delete pod nfs-pod
kubectl apply -f pod-using-pvc.yaml

# Verify data persists
kubectl exec nfs-pod -- cat /usr/share/nginx/html/index.html
# ‚úÖ "Hello from NFS!" ‚Üí data survived Pod deletion!

```

### üîß Step 4: Clean Up

```bash
kubectl delete pod nfs-pod
kubectl delete pvc myclaim
kubectl delete pv pvone-nfs  # Only if reclaimPolicy=Delete (yours is Retain!)

```

> ‚ö†Ô∏è Since your PV uses reclaimPolicy: Retain:
> 
> - PV **won‚Äôt be deleted** automatically
> - You must **manually clean up** NFS directory:
>     
>     ```bash
>     # On NFS server:
>     sudo rm -rf /foldername/*
>     
>     ```
>     

---

### üí° Real-World PVC Best Practices

| Practice | Why |
| --- | --- |
| **Use `ReadWriteMany` for shared apps** | Web servers, CMS, file sharing |
| **Set realistic storage requests** | Avoid wasting space |
| **Use namespaces for PVCs** | Isolate team storage |
| **Monitor PVC usage** | `kubectl get pvc` |

> ‚úÖ Your PVC is well-formed ‚Äî just consider ReadWriteMany if needed.
> 

---

### üÜö Static vs Dynamic Provisioning

| Step | **Static Provisioning** (Your Case) | **Dynamic Provisioning** |
| --- | --- | --- |
| **Admin** | Creates PV manually | Creates StorageClass |
| **User** | Creates PVC ‚Üí binds to PV | Creates PVC ‚Üí auto-creates PV |
| **Use Case** | NFS, existing storage | Cloud disks (EBS, PD) |

> üí° Your next file (storage-class-nfs) will cover dynamic provisioning.
> 

---

### ‚ùì Common Questions

**Q: What if no PV matches the PVC?**

A: PVC stays in **`Pending`** state until a matching PV is created.

**Q: Can I use the same PVC in multiple Pods?**

A: ‚úÖ **Only if `accessModes: ReadWriteMany`** (NFS supports this!).

**Q: What‚Äôs the difference between `storage` and `capacity`?**

A:

- **PVC**: `resources.requests.storage` = what you **request**
- **PV**: `capacity.storage` = what‚Äôs **available**

**Q: Does PVC namespace matter?**

A: ‚úÖ **Yes!** PVCs are **namespaced**, PVs are **cluster-scoped**.

---

### ‚û°Ô∏è Summary

‚úÖ **PVC** = user request for storage

‚úÖ **Binds to PV** based on `storageClassName`, `accessModes`, `storage`

‚úÖ **Enables true persistence** (survives Pod deletion)

üîç In k3s: Test by **writing data** ‚Üí **deleting Pod** ‚Üí **recreating**

‚û°Ô∏è Next: **StorageClass for dynamic NFS provisioning** (`storage-class-nfs`)