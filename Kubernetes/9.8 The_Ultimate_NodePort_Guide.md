# 9.8: NodePort Service for PVC-Backed Apps

https://drive.google.com/file/d/1Ga-gnT2z7j17YMyyRHL_8qb0t3XJdNa-/view?usp=sharing

### ğŸ” YAML Breakdown

```yaml
apiVersion: v1
kind: Service
meta
  name: website-svc
spec:
  type: NodePort          # â† Exposes on ALL node IPs
  selector:
    app: nginx            # â† Must match Deployment labels
  ports:
    - port: 80            # â† Service port (internal)
      targetPort: 80      # â† Pod port (where app listens)
      nodePort: 30007     # â† Fixed external port (30000-32767)

```

> ğŸ”‘ Key Insight:
> 
> 
> This Service creates a **stable external endpoint**:
> 
> - **Internal**: `http://website-svc:80` (from inside cluster)
> - **External**: `http://<ANY-k3s-NODE-IP>:30007` (from your laptop, browser, etc.)

> ğŸ’¡ Why nodePort: 30007?
> 
> - Fixed port = easier firewall rules, documentation, and testing
> - Without it, k3s assigns a **random port** in `30000-32767`

---

### ğŸ“Œ How It Works with Your PVC-Backed App

| Component | Role |
| --- | --- |
| **Deployment (`webapp`)** | Runs 1 Pod with `app: nginx` label + PVC-mounted `/var/www/html` |
| **Service (`website-svc`)** | Routes traffic to that Pod via `selector: app: nginx` |
| **PVC (`myclaim`)** | Persists web content across Pod restarts |
| **NodePort** | Exposes the app externally on `:30007` |

> ğŸ¯ End-to-End Flow:
> 
> 
> `curl http://<NODE-IP>:30007`
> 
> â†’ NodePort (`30007`)
> 
> â†’ Service (`website-svc:80`)
> 
> â†’ Pod (`webapp-xxxx:80`)
> 
> â†’ **Persistent content from NFS/PV**
> 

---

### ğŸ§ª k3s Lab: Test End-to-End Persistence + External Access

### ğŸ”§ Step 1: Ensure All Components Are Deployed

```bash
# 1. PVC (from earlier)
kubectl get pvc myclaim

# 2. Deployment (with PVC)
kubectl apply -f deployment-using-pvc.yaml

# 3. Service
kubectl apply -f service-node-port.yaml

```

### ğŸ”§ Step 2: Write Persistent Content

```bash
# Get Pod name
POD=$(kubectl get pods -l app=nginx -o jsonpath='{.items[0].metadata.name}')

# Write file
kubectl exec $POD -- sh -c "echo '<h1>Hello from Persistent NFS!</h1>' > /var/www/html/index.html"

```

### ğŸ”§ Step 3: Test External Access

> ğŸ’¡ Get k3s node IP(s):
> 

```bash
kubectl get nodes -o wide
# NAME         INTERNAL-IP
# k3s-master   192.168.1.10
# k3s-node1    192.168.1.11

```

> ğŸŒ From your laptop:
> 

```bash
curl <http://192.168.1.10:30007>
# âœ… "Hello from Persistent NFS!"

curl <http://192.168.1.11:30007>
# âœ… Same response! (kube-proxy forwards to Pod anywhere in cluster)

```

### ğŸ”§ Step 4: Simulate Pod Failure (Data Survives)

```bash
# Delete Pod
kubectl delete pod $POD

# Wait for new Pod
kubectl get pods -w -l app=nginx

# Test again
curl <http://192.168.1.10:30007>
# âœ… Still "Hello from Persistent NFS!" â†’ data persisted via PVC!

```

### ğŸ”§ Step 5: Clean Up

```bash
kubectl delete service website-svc
kubectl delete deployment webapp
# Keep PVC if you want to reuse it

```

---

### ğŸ’¡ Real-World Best Practices

| Practice | Why |
| --- | --- |
| **Use fixed `nodePort`** | Easier firewall rules, documentation |
| **Restrict with firewall** | Only allow trusted IPs to `:30007` |
| **Prefer Ingress for HTTP** | Better routing, TLS, path-based rules |
| **Monitor PVC usage** | Ensure NFS has enough space |

> âœ… Your setup is production-ready for single-instance apps (e.g., CMS, legacy web apps).
> 

---

### ğŸ†š NodePort vs Other Service Types

| Type | External Access | Use Case |
| --- | --- | --- |
| **ClusterIP** | âŒ No | Internal microservices |
| **NodePort** | âœ… Yes (`:30000-32767`) | Dev/testing, admin tools |
| **LoadBalancer** | âœ… Yes (public IP) | Production (requires MetalLB in k3s) |
| **Ingress** | âœ… Yes (HTTP/S) | Web apps with TLS, path routing |

> ğŸ’¡ For production web apps in k3s, consider:
> 
> - **MetalLB** â†’ `type: LoadBalancer`
> - **Ingress Controller** (Traefik, Nginx) â†’ path-based routing + TLS

---

### â“ Common Questions

**Q: What if I scale Deployment to 2 replicas?**

A: âš ï¸ **Dangerous with shared PVC!**

- If PVC is `ReadWriteOnce`: Second Pod **stuck in Pending**
- If PVC is `ReadWriteMany` (NFS): Both Pods **overwrite each otherâ€™s data**

**Q: Can I use this with StatefulSet?**

A: âœ… **Yes!** But StatefulSet usually uses **headless Service** + DNS.

**Q: Does NodePort work if Pod is on a different node?**

A: âœ… **Yes!** kube-proxy handles **cross-node forwarding**.

**Q: Is NodePort secure?**

A: âš ï¸ **Expose only necessary ports** + use **firewall rules**.

---

### â¡ï¸ Summary

âœ… **NodePort Service** = external access via **`<NODE-IP>:30007`**

âœ… **Works seamlessly with PVC-backed apps**

âœ… **Data persists** across Pod restarts/deletions

ğŸ” In k3s: Test with `curl http://<NODE-IP>:30007` from your laptop

ğŸ› ï¸ **Use for single-instance persistent apps** (CMS, legacy)